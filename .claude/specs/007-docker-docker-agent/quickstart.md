# 快速启动指南：Docker实例远程管理验证

**功能分支**：`007-docker-docker-agent`
**创建日期**：2025-10-22
**状态**：待验证
**目标**：提供端到端验收场景，验证所有核心功能

---

## 前置条件

### 1. 环境准备

**必需组件**：
- Tiga Server（后端服务）
- Agent（部署在目标主机，已支持Docker管理功能）
- Docker（目标主机上已安装Docker 20.10+）
- 浏览器（支持WebSocket，推荐Chrome/Firefox）

**测试数据准备**：
```bash
# 1. 在Agent主机上启动测试容器
docker run -d --name nginx-test nginx:latest
docker run -d --name redis-test redis:latest

# 2. 拉取测试镜像
docker pull alpine:latest
docker pull ubuntu:22.04

# 3. 检查Docker版本（确保≥20.10）
docker version
```

### 2. 用户角色

**测试账号准备**：
- **Admin用户**：admin@example.com（所有权限）
- **Operator用户**：operator@example.com（可启停容器）
- **Viewer用户**：viewer@example.com（只读权限）

---

## 场景 1：Agent自动发现Docker实例

**目标**：验证Agent上报Docker实例功能（FR-001、FR-002）

**步骤**：

1. **启动Agent**
   ```bash
   # 在目标主机上启动Agent
   ./agent --server https://tiga.example.com --token <agent-token>
   ```

2. **检查Agent连接**
   - 访问Tiga管理界面
   - 导航到 **主机管理 > 主机列表**
   - 确认Agent主机状态为"在线"

3. **验证Docker实例自动创建**
   - 导航到 **Docker管理 > 实例列表**
   - ✅ **验证**：列表中出现新Docker实例
   - ✅ **验证**：实例名称为 `<主机名>-docker`
   - ✅ **验证**：健康状态为 `online`
   - ✅ **验证**：关联的Agent ID正确
   - ✅ **验证**：容器数量、镜像数量正确（容器≥2，镜像≥2）

4. **验证Docker信息显示**
   - 点击实例名称进入详情页
   - ✅ **验证**：Docker版本显示（如 "24.0.7"）
   - ✅ **验证**：API版本显示（如 "1.43"）
   - ✅ **验证**：存储驱动显示（如 "overlay2"）
   - ✅ **验证**：操作系统和架构显示
   - ✅ **验证**：最后连接时间为最近（<5分钟前）

**预期结果**：Docker实例自动注册成功，所有元数据正确

---

## 场景 2：查看容器列表

**目标**：验证容器列表查询和分页功能（FR-008、FR-006）

**步骤**：

1. **访问容器列表**
   - 在Docker实例详情页，点击"容器"标签
   - ✅ **验证**：容器列表显示（至少2个：nginx-test、redis-test）

2. **验证容器信息完整性**
   - 选择 `nginx-test` 容器
   - ✅ **验证**：容器ID显示（12字符短ID）
   - ✅ **验证**：镜像名称显示（"nginx:latest"）
   - ✅ **验证**：状态显示（"running"）
   - ✅ **验证**：端口映射显示（如 "80/tcp → 0.0.0.0:8080"）
   - ✅ **验证**：创建时间和运行时长显示

3. **测试搜索过滤**
   - 在搜索框输入 "nginx"
   - ✅ **验证**：仅显示nginx容器
   - 清空搜索框
   - ✅ **验证**：恢复显示所有容器

4. **测试分页**（需创建50+个容器测试）
   ```bash
   # 在Agent主机上创建多个容器
   for i in {1..60}; do
     docker run -d --name test-container-$i nginx:latest
   done
   ```
   - 刷新容器列表
   - ✅ **验证**：显示分页控件
   - ✅ **验证**：默认显示50条/页
   - 点击"下一页"
   - ✅ **验证**：显示第51-60个容器

5. **测试状态过滤**
   - 停止一个容器：`docker stop nginx-test`
   - 刷新列表
   - 点击"状态"下拉框，选择"已停止"
   - ✅ **验证**：仅显示停止的容器（nginx-test）

**预期结果**：容器列表功能完整，分页和过滤正常工作

---

## 场景 3：容器生命周期管理（需要权限）

**目标**：验证容器启动、停止、重启、删除操作（FR-009）

### 3.1 停止容器（Operator权限）

**步骤**：
1. 以 **Operator** 角色登录
2. 选择运行中的容器（redis-test）
3. 点击"停止"按钮
4. ✅ **验证**：弹出确认对话框
5. 确认操作
6. ✅ **验证**：显示加载动画（操作进行中）
7. 等待2-3秒
8. ✅ **验证**：容器状态变为 `exited`
9. ✅ **验证**：显示成功提示 "容器已停止"
10. 导航到 **系统管理 > 审计日志**
11. ✅ **验证**：有新日志记录
    - 操作类型：`container_stop`
    - 资源名称：`redis-test`
    - 操作者：`operator@example.com`
    - 操作时间：最近（<1分钟）

**预期结果**：容器成功停止，操作记录已创建

### 3.2 启动容器

**步骤**：
1. 选择已停止的容器（redis-test）
2. 点击"启动"按钮
3. ✅ **验证**：容器状态变为 `running`
4. ✅ **验证**：显示成功提示

### 3.3 重启容器

**步骤**：
1. 选择运行中的容器（nginx-test）
2. 点击"重启"按钮
3. ✅ **验证**：容器状态短暂变为 `restarting`，然后恢复 `running`
4. ✅ **验证**：容器启动时间更新（刚刚启动）

### 3.4 删除容器（Admin权限）

**步骤**：
1. 以 **Admin** 角色登录
2. 先停止容器：停止 nginx-test
3. 选择已停止的容器，点击"删除"按钮
4. ✅ **验证**：弹出警告对话框（"删除后无法恢复"）
5. 确认删除
6. ✅ **验证**：容器从列表中消失
7. ✅ **验证**：显示成功提示 "容器已删除"
8. ✅ **验证**：审计日志记录 `container_delete` 操作

**预期结果**：所有容器操作成功，符合权限控制要求

---

## 场景 4：容器日志查看

**目标**：验证实时日志流和历史日志查询（FR-011）

### 4.1 查看历史日志

**步骤**：
1. 选择运行中的容器（redis-test）
2. 点击"日志"按钮
3. ✅ **验证**：弹出日志查看器窗口
4. ✅ **验证**：显示最后100行日志
5. ✅ **验证**：日志包含时间戳
6. ✅ **验证**：日志内容正确（Redis启动日志）

### 4.2 加载更多日志

**步骤**：
1. 在日志查看器中点击"加载更多"下拉框
2. 选择"最后500行"
3. ✅ **验证**：日志内容更新，显示500行
4. ✅ **验证**：加载时间 <2秒

### 4.3 实时跟踪日志

**步骤**：
1. 点击"实时跟踪"按钮
2. ✅ **验证**：按钮变为"停止跟踪"
3. 在Agent主机上触发日志输出：
   ```bash
   docker exec redis-test redis-cli SET test "hello"
   docker exec redis-test redis-cli GET test
   ```
4. ✅ **验证**：日志查看器实时显示新日志（延迟 <1秒）
5. ✅ **验证**：日志自动滚动到底部
6. 点击"停止跟踪"
7. ✅ **验证**：日志停止更新

**预期结果**：日志查看功能完整，实时跟踪延迟低

---

## 场景 5：容器Web终端

**目标**：验证浏览器内容器Shell访问（FR-013）

**步骤**：

1. **打开终端**
   - 选择运行中的容器（redis-test）
   - 点击"终端"按钮
   - ✅ **验证**：弹出新窗口或模态框，显示黑色终端界面

2. **执行基本命令**
   ```bash
   # 输入命令并按Enter
   ls -la
   ```
   - ✅ **验证**：终端显示文件列表输出
   - ✅ **验证**：响应延迟 <100ms

3. **测试交互式命令**
   ```bash
   redis-cli
   SET mykey "Hello World"
   GET mykey
   exit
   ```
   - ✅ **验证**：Redis CLI正常工作
   - ✅ **验证**：输出包含 "Hello World"

4. **测试终端大小调整**
   - 调整浏览器窗口大小
   - 执行 `tput cols` 和 `tput lines`
   - ✅ **验证**：输出列数和行数与浏览器窗口大小一致

5. **测试特殊按键**
   - 按 `Ctrl+C`（发送SIGINT）
   - ✅ **验证**：当前命令被中断
   - 按 `Tab`（自动补全）
   - 输入 `ls /e` 后按Tab
   - ✅ **验证**：自动补全为 `ls /etc/`

6. **测试会话超时**
   - 保持终端打开，不操作
   - 等待31分钟
   - ✅ **验证**：终端自动断开
   - ✅ **验证**：显示提示 "Session ended (timeout)"

7. **测试并发会话**
   - 打开同一容器的第二个终端
   - 在第一个终端创建文件：`touch /tmp/test1.txt`
   - 在第二个终端检查：`ls /tmp/test1.txt`
   - ✅ **验证**：第二个终端能看到文件
   - ✅ **验证**：两个终端独立工作，互不影响

**预期结果**：Web终端功能完整，响应流畅，支持并发会话

---

## 场景 6：镜像管理

**目标**：验证镜像查看、删除、拉取功能（FR-014 ~ FR-017）

### 6.1 查看镜像列表

**步骤**：
1. 在Docker实例详情页，点击"镜像"标签
2. ✅ **验证**：镜像列表显示（至少3个：nginx、redis、alpine）
3. ✅ **验证**：每个镜像显示：
   - 镜像名称和标签（如 "nginx:latest"）
   - 镜像ID（短格式）
   - 大小（如 "142 MB"）
   - 创建时间

### 6.2 查看镜像详情

**步骤**：
1. 点击 nginx 镜像进入详情页
2. ✅ **验证**：显示完整信息：
   - 完整镜像ID（64字符）
   - 所有标签列表
   - 镜像层列表（Layer IDs）
   - 暴露端口（如 "80/tcp"）
   - 环境变量
   - 启动命令

### 6.3 删除未使用镜像（Admin权限）

**步骤**：
1. 以 Admin 角色登录
2. 在Agent主机上创建测试镜像：
   ```bash
   docker pull busybox:latest
   ```
3. 刷新镜像列表
4. ✅ **验证**：busybox 镜像出现
5. 选择 busybox 镜像，点击"删除"按钮
6. ✅ **验证**：弹出确认对话框
7. 确认删除
8. ✅ **验证**：镜像从列表中消失
9. ✅ **验证**：审计日志记录 `image_delete` 操作

### 6.4 删除被容器使用的镜像（失败场景）

**步骤**：
1. 尝试删除 nginx 镜像（nginx-test 容器正在使用）
2. ✅ **验证**：删除失败
3. ✅ **验证**：显示错误提示 "镜像被容器使用，无法删除"
4. ✅ **验证**：镜像仍在列表中

### 6.5 拉取镜像（Admin权限）

**步骤**：
1. 点击"拉取镜像"按钮
2. 在弹出对话框中输入镜像名称：`alpine:3.18`
3. 点击"拉取"
4. ✅ **验证**：显示拉取进度条
5. ✅ **验证**：进度更新（如 "Pulling fs layer", "Downloading 50%"）
6. 等待拉取完成（约10-30秒）
7. ✅ **验证**：显示成功提示 "镜像拉取完成"
8. 刷新镜像列表
9. ✅ **验证**：alpine:3.18 镜像出现

### 6.6 拉取私有镜像（需要认证）

**前置条件**：配置私有Registry凭证（Phase 2功能，可跳过）

**步骤**：
1. 导航到 **Docker管理 > Registry凭证**
2. 点击"添加凭证"
3. 输入：
   - Registry URL：`registry.example.com`
   - 用户名：`testuser`
   - 密码：`testpass`
4. 保存凭证
5. 拉取私有镜像：`registry.example.com/myapp:v1`
6. ✅ **验证**：拉取成功，使用配置的凭证

**预期结果**：镜像管理功能完整，权限控制正确

---

## 场景 7：Agent离线场景

**目标**：验证Agent离线时的优雅降级（FR-007a）

**步骤**：

1. **模拟Agent离线**
   ```bash
   # 在Agent主机上停止Agent
   pkill -f agent
   ```

2. **等待健康检查检测（最多60秒）**
   - 等待1-2分钟
   - 刷新Docker实例列表

3. **验证实例状态变化**
   - ✅ **验证**：实例健康状态变为 `offline`
   - ✅ **验证**：状态指示器显示红色或灰色图标
   - ✅ **验证**：显示离线时间（"1分钟前离线"）

4. **验证操作禁用**
   - 点击离线实例进入详情页
   - ✅ **验证**：所有操作按钮禁用（启动、停止、删除等）
   - ✅ **验证**：悬停时显示提示 "实例离线，操作不可用"

5. **验证历史数据保留**
   - 点击"容器"标签
   - ✅ **验证**：显示容器列表（离线前的快照数据）
   - ✅ **验证**：容器数量正确
   - ✅ **验证**：显示警告提示 "实例离线，数据可能已过时"

6. **验证离线状态API**
   - 尝试调用容器列表API：
     ```bash
     curl -H "Authorization: Bearer <token>" \
          http://localhost:12306/api/v1/docker/instances/<instance-id>/containers
     ```
   - ✅ **验证**：返回 503 状态码
   - ✅ **验证**：错误消息："Docker实例离线，无法获取容器列表"

7. **恢复Agent上线**
   ```bash
   # 重新启动Agent
   ./agent --server https://tiga.example.com --token <agent-token>
   ```
   - 等待1分钟
   - 刷新实例列表
   - ✅ **验证**：实例状态恢复为 `online`
   - ✅ **验证**：操作按钮重新启用
   - ✅ **验证**：最后连接时间更新

**预期结果**：离线场景优雅降级，数据保留，操作禁用明确

---

## 场景 8：Agent删除级联处理

**目标**：验证Agent删除时Docker实例的软删除策略（FR-007b）

**步骤**：

1. **删除Agent**
   - 导航到 **主机管理 > 主机列表**
   - 选择测试Agent主机
   - 点击"删除"按钮
   - 确认删除

2. **验证Docker实例状态变化**
   - 导航到 **Docker管理 > 实例列表**
   - ✅ **验证**：关联的Docker实例状态变为 `archived`
   - ✅ **验证**：实例显示特殊标识（如归档图标）

3. **验证已归档实例限制**
   - 点击已归档实例进入详情页
   - ✅ **验证**：所有操作按钮禁用
   - ✅ **验证**：显示提示 "实例已归档，仅供查看"

4. **验证历史数据保留**
   - ✅ **验证**：容器列表仍可查看（归档前快照）
   - ✅ **验证**：镜像列表仍可查看
   - ✅ **验证**：审计日志完整保留

5. **手动清理已归档实例**
   - 在实例详情页点击"删除实例"按钮
   - 确认删除
   - ✅ **验证**：实例从列表中消失
   - ✅ **验证**：所有关联数据被删除

**预期结果**：Agent删除时Docker实例软删除，数据保留供查询

---

## 场景 9：权限验证

**目标**：验证基于操作类型的访问控制（FR-023）

### 9.1 Viewer（只读）权限

**步骤**：
1. 以 **Viewer** 角色登录
2. 导航到Docker实例列表
3. ✅ **验证**：可以查看实例列表
4. 进入实例详情页
5. ✅ **验证**：可以查看容器列表
6. ✅ **验证**：可以查看镜像列表
7. ✅ **验证**：可以查看容器日志
8. ✅ **验证**：可以打开容器终端（但不应执行修改命令）
9. 尝试停止容器
10. ✅ **验证**：按钮禁用或点击后返回403错误
11. ✅ **验证**：显示错误提示 "权限不足，需要Operator权限"

### 9.2 Operator（操作员）权限

**步骤**：
1. 以 **Operator** 角色登录
2. ✅ **验证**：可以执行启动、停止、重启操作
3. 尝试删除容器
4. ✅ **验证**：按钮禁用或返回403错误
5. ✅ **验证**：显示错误提示 "权限不足，需要Admin权限"
6. 尝试删除镜像
7. ✅ **验证**：按钮禁用或返回403错误

### 9.3 Admin（管理员）权限

**步骤**：
1. 以 **Admin** 角色登录
2. ✅ **验证**：可以执行所有操作（启动、停止、删除等）
3. ✅ **验证**：可以删除容器
4. ✅ **验证**：可以删除镜像
5. ✅ **验证**：可以拉取镜像
6. ✅ **验证**：可以修改实例配置

**预期结果**：权限控制严格，符合RBAC设计

---

## 场景 10：性能验证

**目标**：验证系统性能满足目标（FR性能要求）

### 10.1 容器列表加载性能

**前置条件**：创建100个容器
```bash
for i in {1..100}; do
  docker run -d --name perf-test-$i nginx:latest
done
```

**步骤**：
1. 清空浏览器缓存
2. 打开浏览器开发者工具 Network 标签
3. 访问容器列表页（100个容器）
4. ✅ **验证**：API响应时间 <2秒（目标）
5. ✅ **验证**：页面渲染完成时间 <3秒
6. ✅ **验证**：滚动流畅，无卡顿

### 10.2 Agent gRPC调用延迟

**步骤**：
1. 查看审计日志中的操作耗时
2. 执行10次容器停止操作
3. 统计平均耗时
4. ✅ **验证**：p95延迟 <500ms（目标）
5. ✅ **验证**：p99延迟 <1秒

### 10.3 实时日志流延迟

**步骤**：
1. 打开容器实时日志
2. 在Agent主机上触发日志输出：
   ```bash
   docker exec redis-test sh -c 'for i in {1..10}; do echo "Test log $i"; sleep 0.1; done'
   ```
3. 记录日志在浏览器中出现的时间
4. ✅ **验证**：平均延迟 <100ms（目标）

### 10.4 Web终端响应延迟

**步骤**：
1. 打开容器终端
2. 快速输入命令：`echo test`
3. 测量从按Enter到看到输出的时间
4. ✅ **验证**：延迟 <50ms（目标）

**预期结果**：所有性能指标满足设计目标

---

## 场景 11：并发操作测试

**目标**：验证并发场景下的冲突处理（研究任务3决策）

### 11.1 两人同时停止容器

**步骤**：
1. 用户A和用户B同时登录（两个浏览器窗口）
2. 两人同时选择同一运行中容器（nginx-test）
3. 两人几乎同时点击"停止"按钮（相差<1秒）
4. ✅ **验证**：两个操作都返回成功（Docker API幂等性）
5. ✅ **验证**：容器最终状态为 `exited`
6. ✅ **验证**：审计日志记录两条操作（两人各一条）

### 11.2 两人同时删除容器

**步骤**：
1. 两人同时选择已停止的容器
2. 两人几乎同时点击"删除"按钮
3. ✅ **验证**：第一个操作成功
4. ✅ **验证**：第二个操作返回错误 "容器不存在" 或 "操作进行中"
5. ✅ **验证**：容器最终被删除

**预期结果**：并发操作安全，无数据不一致

---

## 故障排查清单

**常见问题**：

1. **Agent无法连接**
   - 检查：Agent日志中是否有连接错误
   - 检查：网络连通性（ping、telnet）
   - 检查：Token是否有效

2. **Docker实例未自动创建**
   - 检查：Agent是否有Docker socket访问权限（`docker ps` 是否成功）
   - 检查：Agent日志中是否有错误
   - 手动触发健康检查

3. **容器操作超时**
   - 检查：Agent与Docker守护进程的连接
   - 检查：网络延迟（ping Agent主机）
   - 查看操作耗时（审计日志）

4. **终端无法连接**
   - 检查：浏览器是否支持WebSocket
   - 检查：浏览器控制台是否有错误
   - 检查：JWT token是否有效
   - 检查：会话是否已过期

5. **日志不显示**
   - 检查：容器是否有日志输出（`docker logs <container>`）
   - 检查：Agent gRPC连接是否正常
   - 检查：浏览器控制台网络请求状态

---

## 完整验收清单

**必需场景（P0）**：
- [x] 场景1：Agent自动发现Docker实例 ✅
- [x] 场景2：查看容器列表 ✅
- [x] 场景3：容器生命周期管理 ✅
- [x] 场景4：容器日志查看 ✅
- [x] 场景5：容器Web终端 ✅
- [x] 场景6：镜像管理 ✅
- [x] 场景7：Agent离线场景 ✅
- [x] 场景9：权限验证 ✅

**可选场景（P1）**：
- [ ] 场景8：Agent删除级联处理
- [ ] 场景10：性能验证
- [ ] 场景11：并发操作测试

**测试报告格式**：
```
# Docker实例远程管理验收测试报告

**测试日期**：YYYY-MM-DD
**测试人员**：姓名
**测试环境**：
- Tiga版本：vX.X.X
- Agent版本：vX.X.X
- Docker版本：XX.XX.X

## 测试结果摘要
- 总场景数：11
- 通过场景：10
- 失败场景：1
- 通过率：90.9%

## 详细结果
| 场景编号 | 场景名称 | 结果 | 备注 |
|---------|---------|------|------|
| 1 | Agent自动发现 | ✅ 通过 | 所有验证点通过 |
| 2 | 容器列表 | ✅ 通过 | - |
| 3 | 生命周期管理 | ❌ 失败 | 删除操作超时 |
| ... | ... | ... | ... |

## 问题清单
1. **容器删除超时**
   - 现象：删除操作30秒无响应
   - 原因：Agent与Docker连接超时
   - 修复计划：调整超时参数

## 结论
功能基本满足需求，存在1个需修复的问题。
```

---

**验收指南版本**：v1.0.0
**创建时间**：2025-10-22
**状态**：待实施后验证
