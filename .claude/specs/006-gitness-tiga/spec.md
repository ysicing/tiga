# 功能规格：定时任务和审计系统重构

**功能分支**：`006-gitness-tiga`
**创建日期**：2025-10-19
**状态**：草稿
**输入**：用户描述："参考gitness的定时任务和审计机制来重构tiga的定时任务和审计，不需要考虑向后兼容"

## 执行流程（main）
```
1. 从输入解析用户描述
   → 分析 Gitness 和 Tiga 的实现差异
2. 提取关键设计模式
   → Scheduler: 分布式锁、队列系统、任务状态追踪
   → Audit: 强类型系统、接口设计、Functional Options、Diff 对象
3. 识别重构范围
   → Scheduler 完全重构（无向后兼容要求）
   → Audit 完全重构（无向后兼容要求）
4. 生成功能需求
   → 所有需求基于 Gitness 设计模式
5. 定义数据模型
   → 基于强类型和验证机制
6. 运行审查清单
   → 验证业务需求完整性
7. 返回：规格已准备好进行规划
```

---

## ⚡ 快速指南
- ✅ 专注于重构后的系统能力和用户价值
- ✅ 参考 Gitness 的设计模式和架构
- ❌ 避免实现细节（具体的 Go 包、数据库 schema）
- 👥 为系统管理员和开发者编写

---

## 澄清

### 会话 2025-10-19

- 问：审计日志保留策略 → 答：默认90天，支持后台配置
- 问：分布式锁实现基础 → 答：支持多种实现可配置切换，默认数据库
- 问：审计日志写入失败的备用存储 → 答：不使用备用存储，丢弃并告警
- 问：任务执行超时后的终止机制 → 答：Context取消 + 宽限期后强制终止
- 问：审计日志对象数据大小限制 → 答：64KB（保证结构完整性，截断超长字段值）

---

## 用户场景与测试 *（必填）*

### 主要用户故事

**作为 Tiga 系统管理员**，我需要一个可靠的定时任务调度系统，能够：
1. 在分布式环境中运行而不会重复执行任务
2. 查看任务执行历史和状态
3. 动态启用/禁用任务而不重启服务
4. 监控任务执行性能和失败率
5. 对任务进行分组和优先级管理

**作为 Tiga 系统管理员**，我需要一个完善的审计系统，能够：
1. 记录所有关键操作的完整上下文（谁、什么、何时、在哪里）
2. 追踪资源变更的前后差异
3. 支持不同资源类型的标准化审计
4. 通过强类型约束防止审计数据不一致
5. 高效查询和分析审计日志

### 验收场景

#### Scheduler 场景

1. **假定** 有两个 Tiga 实例运行在不同服务器上，**当** 定时任务触发时，**那么** 只有一个实例执行任务（通过分布式锁保证）

2. **假定** 系统管理员想要查看过去 24 小时的任务执行情况，**当** 访问任务历史 API，**那么** 返回所有任务的执行记录（开始时间、结束时间、状态、错误信息）

3. **假定** 某个任务执行失败，**当** 系统记录失败原因，**那么** 管理员可以通过 API 查询失败详情并决定是否手动重试

4. **假定** 管理员需要临时禁用数据库审计清理任务，**当** 调用禁用 API，**那么** 任务立即停止执行且不影响其他任务

5. **假定** 系统有 10 个定时任务，**当** 系统负载较高时，**那么** 可以根据任务优先级和资源标签调度任务

#### Audit 场景

1. **假定** 用户删除一个数据库实例，**当** 操作执行时，**那么** 审计日志记录包含删除前的完整对象数据（用于恢复或审查）

2. **假定** 审计日志记录用户创建 Kubernetes 集群，**当** 查询审计日志，**那么** 可以看到操作者、客户端 IP、集群配置、操作时间、请求 ID（用于关联请求）

3. **假定** 系统管理员需要审查所有失败的审计操作，**当** 查询状态为"失败"的审计日志，**那么** 返回包含错误消息和请求上下文的日志

4. **假定** 用户更新数据库用户权限，**当** 审计日志记录时，**那么** 包含变更前后的权限差异（OldObject vs NewObject）

5. **假定** 审计日志记录来自负载均衡器后的请求，**当** 提取客户端 IP，**那么** 正确解析 X-Forwarded-For、X-Real-IP、True-Client-IP 等 header

### 边缘情况

#### Scheduler 边缘情况
- 当分布式锁获取失败时会发生什么？（跳过本次执行，等待下次调度）
- 当任务执行时间超过调度间隔时会发生什么？（不会重复启动，等待当前执行完成）
- 当数据库连接断开时会发生什么？（任务执行失败，记录错误，下次重试）
- 系统如何处理任务 panic？（恢复 panic，记录堆栈，标记任务失败）
- 当系统重启时正在执行的任务会发生什么？（状态标记为中断，支持手动重试）

#### Audit 边缘情况
- 当审计日志写入失败时会发生什么？（不使用备用存储，丢弃该审计日志并触发告警通知管理员，优先保证业务操作不阻塞）
- 当记录的对象数据过大时会发生什么？（限制单个对象数据最大64KB，在保证整体数据结构完整性的前提下，智能截断超长字段的值，截断的字段标记"...[truncated]"，并在审计日志中添加截断标识）
- 系统如何处理匿名用户操作？（使用特殊的匿名用户标识）
- 当资源类型未定义时会发生什么？（验证失败，拒绝记录并记录错误）
- 系统如何防止审计日志被篡改？（只能创建和查询，不支持修改和删除）

---

## 需求 *（必填）*

### 功能需求

#### Scheduler 需求

**FR-S001**：系统必须支持分布式环境下的任务调度，确保同一任务不会在多个实例上同时执行

**FR-S001a**：系统必须支持多种分布式锁实现（数据库行锁、Redis、etcd），默认使用数据库行锁

**FR-S001b**：系统必须支持通过配置切换分布式锁实现，无需代码修改

**FR-S002**：系统必须记录每次任务执行的历史（开始时间、结束时间、执行状态、错误信息、执行实例）

**FR-S003**：系统必须支持任务的动态启用和禁用，无需重启服务

**FR-S004**：系统必须支持查询任务执行历史，包括分页、过滤（按任务名称、状态、时间范围）

**FR-S005**：系统必须支持手动触发任务执行（用于调试和紧急情况）

**FR-S006**：系统必须支持任务执行超时控制，超时后先通过 Context 取消优雅终止，宽限期后强制终止并标记为失败

**FR-S006a**：系统必须支持配置超时宽限期（默认30秒），宽限期内等待任务自行清理资源

**FR-S007**：系统必须支持任务执行的优先级和资源标签匹配（类似 Gitness 的 Filter 机制）

**FR-S008**：系统必须在任务执行失败时记录详细的错误堆栈和上下文信息

**FR-S009**：系统必须提供任务执行的统计数据（成功率、平均执行时间、失败次数）

**FR-S010**：系统必须支持任务执行的并发控制（限制同时执行的任务数量）

#### Audit 需求

**FR-A001**：系统必须使用强类型定义所有审计操作（Action）和资源类型（ResourceType），防止拼写错误和不一致

**FR-A002**：系统必须记录资源变更的前后差异（OldObject 和 NewObject），支持审计追溯

**FR-A002a**：系统必须限制单个对象数据（OldObject/NewObject）最大为 64KB，在保证数据结构完整性的前提下智能截断超长字段值（保留字段名和结构，截断内容标记"...[truncated]"）

**FR-A002b**：系统必须在审计日志中添加截断标识字段，标明哪些对象数据发生了截断

**FR-A003**：系统必须验证审计事件的完整性，确保必填字段（用户、资源、操作、时间戳）存在

**FR-A004**：系统必须支持 Functional Options 模式，灵活配置审计事件（如添加自定义数据、请求 ID、客户端 IP）

**FR-A005**：系统必须正确提取客户端真实 IP，支持代理 header（X-Forwarded-For、X-Real-IP、True-Client-IP）

**FR-A006**：系统必须支持不同资源类型的标准化审计字段（资源 ID、资源名称、资源路径、资源数据）

**FR-A007**：系统必须通过上下文（Context）传递审计信息，避免全局变量

**FR-A008**：系统必须支持审计日志的高效查询（按用户、资源类型、操作、时间范围、状态）

**FR-A009**：系统必须防止审计日志被修改或删除（只能创建和查询）

**FR-A010**：系统必须支持审计日志的异步写入，不阻塞业务操作

**FR-A011**：系统必须支持审计日志的批量写入，提高性能

**FR-A012**：系统必须在审计日志写入失败时丢弃该日志并触发告警（不阻塞业务操作，不使用备用存储）

**FR-A013**：系统必须支持审计日志和任务执行历史的保留期配置，默认90天

**FR-A014**：系统必须支持通过后台配置界面调整日志保留期，立即生效

### 非功能需求

**NFR-001**：Scheduler 的分布式锁操作延迟不应超过 100ms（99th percentile）

**NFR-002**：Audit 日志异步写入延迟不应超过 1 秒（平均值）

**NFR-003**：Scheduler 任务执行历史查询响应时间不应超过 500ms（包含 1000 条记录）

**NFR-004**：Audit 日志查询响应时间不应超过 2 秒（包含 10000 条记录，有索引支持）

**NFR-005**：系统必须支持至少 1000 个并发审计日志写入请求

**NFR-006**：Scheduler 必须支持至少 100 个定时任务同时运行

**NFR-007**：审计日志记录不应导致业务操作性能下降超过 5%

### 关键实体 *（如果功能涉及数据则包含）*

#### Scheduler 实体

**ScheduledTask**：定时任务配置
- 任务名称、任务类型、调度间隔、启用状态
- 优先级、资源标签、超时时间
- 并发控制策略

**TaskExecution**：任务执行历史
- 任务名称、执行实例、开始时间、结束时间
- 执行状态（pending、running、success、failure、timeout、canceled）
- 错误信息、堆栈跟踪、执行结果数据

**TaskLock**：分布式锁记录
- 锁键、持有者实例、获取时间、过期时间
- 锁状态（active、expired、released）

#### Audit 实体

**AuditEvent**：审计事件
- 事件 ID、时间戳、操作（Action）、用户（Principal）
- 资源（Resource）、资源路径（SpacePath）
- 差异对象（DiffObject：OldObject、NewObject）
- 客户端信息（IP、UserAgent、RequestMethod、RequestID）
- 事件数据（自定义键值对）

**Action**：操作类型（枚举）
- Created、Updated、Deleted、Bypassed、ForcePush（参考 Gitness）
- 支持验证方法确保操作合法性

**ResourceType**：资源类型（枚举）
- Cluster、Database、User、Role、Instance、MinIO、Redis、MySQL、PostgreSQL
- 支持验证方法确保资源类型合法性

**Resource**：资源定义
- 资源类型（ResourceType）、资源标识符（Identifier）
- 资源数据（键值对，如 resourceName、clusterName、repoPath）

**Principal**：操作主体
- 用户 ID、用户名、用户类型（user、service、anonymous）

---

## 审查与验收清单

### 内容质量
- [x] 没有实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 为技术管理员和系统设计者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 需求可测试且明确
- [x] 成功标准可衡量（性能指标、功能验收）
- [x] 范围明确界定（Scheduler + Audit 重构）
- [x] 已识别边缘情况和错误处理
- [x] 所有关键实体已定义

### 设计参考
- [x] 参考 Gitness 的 job.Scheduler 和 job.Executor 架构（定时任务调度）
- [x] 参考 Gitness 的 cleanup 服务实现（任务注册和执行模式）
- [x] 参考 Gitness 的分布式锁机制（lock.MutexManager）
- [x] 参考 Gitness 的强类型审计（Action、ResourceType、Resource）
- [x] 参考 Gitness 的 Functional Options 模式（WithID、WithNewObject、WithOldObject）
- [x] 参考 Gitness 的验证机制（Event.Validate）
- [x] 参考 Gitness 的上下文管理（Context 传递审计信息）

---

## 执行状态

- [x] 用户描述已解析
- [x] 关键概念已提取（Scheduler、Audit 设计模式）
- [x] 用户场景已定义（管理员操作、查询、监控）
- [x] 需求已生成（22 个功能需求 + 7 个非功能需求）
- [x] 实体已识别（Scheduler 3 个 + Audit 5 个）
- [x] 审查清单已通过

---

## 附加说明

### 与现有系统的关系

本次重构将**完全替换**以下 Tiga 现有组件：
1. `internal/services/scheduler/` - 完全重构为分布式任务调度系统
2. `internal/api/middleware/audit.go` - 重构为强类型审计系统
3. `internal/models/audit_log.go` - 迁移到新的审计事件模型
4. `internal/repository/audit_repo.go` - 适配新的审计数据结构

### 保留的业务功能

重构后系统必须继续支持：
1. 所有现有定时任务（alert_processing、database_audit_cleanup 等）
2. 所有现有审计日志查询 API
3. 现有的审计日志存储（可迁移历史数据或双写过渡）

### 技术债务清理

本次重构将解决以下技术债务：
1. 移除全局变量依赖（如 `globalAuditMiddleware`）
2. 移除 goroutine 泄漏风险（当前 audit 中间件的 goroutine 无超时控制）
3. 移除简单的字符串匹配（action、resourceType 使用枚举）
4. 增加分布式环境支持（当前 Scheduler 无法在多实例环境运行）
5. 增加任务执行可观测性（当前无任务历史和统计）

### 成功指标

重构成功的量化标准：
1. **可靠性**：分布式环境下任务不重复执行（100%）
2. **性能**：审计日志写入不影响业务性能（<5% 性能损失）
3. **可观测性**：所有任务执行有历史记录和统计数据
4. **类型安全**：所有审计操作和资源类型通过编译时检查
5. **可维护性**：代码覆盖率达到 80%（单元测试 + 集成测试）

---

## 规格状态：准备就绪

本规格已完成所有必填章节，定义了清晰的用户场景、验收标准、功能需求和数据实体。下一步可进入 **planning 阶段**（使用 `/spec-kit:plan`）。
