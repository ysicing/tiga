# 功能规格：K8s 终端录制与审计增强

**功能分支**：`010-k8s-pod-009`
**创建日期**：2025-10-27
**状态**：草稿
**输入**：用户描述："支持 K8s 终端（节点终端、Pod 容器终端）录制功能，与统一终端录制系统（009-3）集成。梳理和增强 K8s 操作审计功能，记录所有集群操作（创建、更新、删除、终端访问）到统一 AuditEvent 系统。"

## 执行流程（main）
```
1. 从输入解析用户描述
   → 识别两个核心功能：终端录制 + 操作审计
2. 提取关键概念
   → 参与者：集群管理员、运维人员
   → 操作：终端连接、资源操作、审计查询
   → 数据：终端录制文件、审计日志
   → 约束：与现有系统（009-3、统一 AuditEvent）集成
3. 标记不清晰的方面
   → [需要澄清：录制格式是否必须是 Asciinema？]
   → [需要澄清：录制功能是否默认启用？]
   → [需要澄清：是否需要审计只读操作？]
4. 填充用户场景与测试部分
   → 场景1：管理员连接节点终端并自动录制
   → 场景2：运维人员查看审计日志
5. 生成功能需求
   → 每个需求可测试且明确
6. 识别关键实体
   → TerminalRecording（复用 009-3）
   → AuditEvent（统一审计系统）
   → K8sTerminalSession
7. 运行审查清单
   → 警告：规格存在 3 个不确定性需要澄清
8. 返回：成功（规格已准备好进行澄清阶段）
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现（不涉及技术栈、API、代码结构）
- 👥 为业务利益相关者而非开发人员编写

### 章节要求
- **必填章节**：每个功能都必须完成
- **可选章节**：仅在与功能相关时包含
- 当某个章节不适用时，完全移除（不要保留为"不适用"）

---

## 澄清

### 会话 2025-10-27

- 问：录制格式是否必须使用 Asciinema v2 格式？ → 答：是，必须使用 Asciinema v2 格式（与 009-3 保持一致）
- 问：录制功能是否默认启用？ → 答：是，默认启用（所有终端会话自动录制）
- 问：是否需要审计只读操作（如查看 Pod 详情、查看日志、查看 YAML）？ → 答：是，需要审计只读操作（完整访问追踪）
- 问：审计日志保留期限是多久？ → 答：90 天（与其他审计日志和终端录制系统保持一致）
- 问：终端会话是否需要限制最大录制时长？ → 答：是，限制为 2 小时（防止单个录制文件过大，保证回放性能）

---

## 用户场景与测试 *（必填）*

### 主要用户故事

**故事 1：终端会话录制**
作为集群管理员，我希望系统自动录制所有终端会话（节点终端和容器终端），以便：
- 审计运维操作
- 回溯问题排查过程
- 满足安全合规要求

**故事 2：操作审计日志**
作为安全审计员，我希望系统记录所有 Kubernetes 资源操作（创建、更新、删除、终端访问），以便：
- 追踪谁在何时做了什么
- 满足监管合规要求
- 发现异常操作行为

**故事 3：审计日志查询**
作为运维主管，我希望能够查询和筛选审计日志，以便：
- 定位特定用户的操作历史
- 分析特定时间段的操作记录
- 导出审计报告

### 验收场景

#### 场景组 1：节点终端录制

1. **假定** 集群管理员已登录系统，**当** 用户通过 Web 界面连接到 K8s 节点终端，**那么** 系统自动开始录制终端会话到统一录制系统
2. **假定** 节点终端会话正在录制，**当** 用户断开终端连接，**那么** 系统停止录制并保存录制文件
3. **假定** 节点终端会话已结束，**当** 管理员查看录制列表，**那么** 可以看到该会话的录制记录（包含节点名称、持续时间、时间戳）
4. **假定** 管理员找到特定录制记录，**当** 点击回放，**那么** 系统使用 Asciinema 播放器展示终端操作过程

#### 场景组 2：容器终端录制

5. **假定** 运维人员已登录系统，**当** 用户通过 Web 界面 Exec 进入 Pod 容器终端，**那么** 系统自动开始录制容器终端会话
6. **假定** 容器终端会话正在录制，**当** 用户在容器内执行命令（如 ls、cat、vi），**那么** 系统完整记录所有输入输出
7. **假定** 容器终端会话已结束，**当** 管理员查看录制列表，**那么** 可以看到该会话的录制记录（包含 Pod 名称、容器名称、命名空间、持续时间）

#### 场景组 3：K8s 资源操作审计

8. **假定** 管理员已登录系统，**当** 用户通过 Web 界面创建新的 Deployment，**那么** 系统记录审计日志（操作类型：创建，资源类型：Deployment，资源名称，操作者，时间戳）
9. **假定** 管理员已登录系统，**当** 用户通过 Web 界面删除 Service，**那么** 系统记录审计日志（操作类型：删除，资源类型：Service，删除前的资源详情）
10. **假定** 管理员已登录系统，**当** 用户通过 Web 界面更新 ConfigMap，**那么** 系统记录审计日志（操作类型：更新，资源类型：ConfigMap，变更内容摘要）

#### 场景组 4：终端访问审计

11. **假定** 运维人员已登录系统，**当** 用户连接到节点终端，**那么** 系统记录终端访问审计日志（操作类型：NodeTerminalAccess，节点名称，操作者，客户端IP）
12. **假定** 运维人员已登录系统，**当** 用户 Exec 进入容器终端，**那么** 系统记录终端访问审计日志（操作类型：PodTerminalAccess，Pod 名称，容器名称，操作者）

#### 场景组 5：审计日志查询

13. **假定** 安全审计员已登录系统，**当** 用户打开审计日志页面，**那么** 系统展示最近 100 条审计记录（按时间倒序）
14. **假定** 安全审计员在审计日志页面，**当** 用户按操作者筛选，**那么** 系统仅显示该用户的操作记录
15. **假定** 安全审计员在审计日志页面，**当** 用户按操作类型筛选（如"删除"），**那么** 系统仅显示删除操作的审计记录
16. **假定** 安全审计员在审计日志页面，**当** 用户按时间范围筛选，**那么** 系统显示该时间段内的审计记录

### 边缘情况

#### 终端录制边缘情况
- **当终端会话超过 2 小时**时，系统自动停止录制并保存文件，但保持终端连接（已明确：限制为 2 小时）
- **当录制文件超过 100MB**时会发生什么？系统是否自动截断或拆分文件？
- **当终端会话异常断开（网络中断）**时，系统如何处理未完成的录制？
- **当多个用户同时连接同一节点**时，系统如何区分和录制各自的会话？
- **当存储空间不足**时，系统如何处理？是否阻止新的终端连接？

#### 审计日志边缘情况
- **当审计日志数据库满**时会发生什么？是否自动清理旧日志？
- **当用户执行批量操作（如批量删除 100 个 Pod）**时，系统如何记录？是否合并为一条记录？
- **当资源操作失败（如创建 Deployment 失败）**时，系统是否记录失败的审计日志？
- **当只读操作（如查看 Pod 详情、查看日志）**时，系统记录完整的只读审计日志（已明确：需要审计只读操作）
- **当系统管理员查看审计日志本身**时，是否需要记录这个"查看审计日志"的操作？

#### 集成边缘情况
- **当统一终端录制系统（009-3）不可用**时会发生什么？终端功能是否降级使用（不录制）？
- **当录制文件损坏**时会发生什么？系统如何处理无法回放的 Asciinema 文件？

---

## 需求 *（必填）*

### 功能需求

#### FR-1 组：节点终端录制

- **FR-101**：系统必须在用户连接节点终端时自动开始录制会话
- **FR-102**：系统必须在用户断开节点终端时自动停止录制并保存文件
- **FR-103**：节点终端录制必须包含完整的输入输出内容（命令、输出、错误信息）
- **FR-104**：节点终端录制必须记录会话元数据（节点名称、用户、开始时间、结束时间、持续时间）
- **FR-105**：节点终端录制必须存储到统一终端录制系统（009-3 TerminalRecording 模型）
- **FR-106**：节点终端录制的 `recording_type` 字段必须设置为 `"k8s_node"`
- **FR-107**：节点终端录制的 `type_metadata` 字段必须包含 `cluster_id`、`node_name`

#### FR-2 组：容器终端录制

- **FR-201**：系统必须在用户 Exec 进入容器终端时自动开始录制会话
- **FR-202**：系统必须在用户退出容器终端时自动停止录制并保存文件
- **FR-203**：容器终端录制必须包含完整的输入输出内容
- **FR-204**：容器终端录制必须记录会话元数据（Pod 名称、容器名称、命名空间、集群 ID、用户、时间戳）
- **FR-205**：容器终端录制必须存储到统一终端录制系统（009-3 TerminalRecording 模型）
- **FR-206**：容器终端录制的 `recording_type` 字段必须设置为 `"k8s_pod"`
- **FR-207**：容器终端录制的 `type_metadata` 字段必须包含 `cluster_id`、`namespace`、`pod_name`、`container_name`

#### FR-3 组：录制格式与存储

- **FR-301**：终端录制必须使用 Asciinema v2 格式（与 009-3 统一终端录制系统保持一致）
- **FR-302**：录制文件必须使用统一终端录制系统的存储服务（本地存储或 MinIO）
- **FR-303**：录制功能必须默认启用（所有终端会话自动录制）
- **FR-304**：单个终端会话录制时长必须限制为 2 小时（7200 秒）
- **FR-305**：当终端会话达到 2 小时限制时，系统必须自动停止录制并保存文件，但保持终端连接（不断开用户会话）
- **FR-306**：系统必须在录制达到时长限制时向用户发送通知（WebSocket 消息）
- **FR-307**：录制文件必须遵循统一终端录制系统的保留策略（默认 90 天）
- **FR-308**：录制文件必须在达到保留期限后自动清理（通过 009-3 的 CleanupService）

#### FR-4 组：K8s 资源操作审计

- **FR-401**：系统必须记录所有通过 Web 界面执行的 K8s 资源创建操作
- **FR-402**：系统必须记录所有通过 Web 界面执行的 K8s 资源更新操作
- **FR-403**：系统必须记录所有通过 Web 界面执行的 K8s 资源删除操作
- **FR-404**：资源操作审计日志必须包含：操作类型、资源类型、资源名称、命名空间、集群 ID、操作者、时间戳、客户端 IP
- **FR-405**：资源操作审计日志必须包含变更详情（对于更新操作，记录变更内容摘要）
- **FR-406**：资源操作审计日志必须使用统一 AuditEvent 系统存储
- **FR-407**：资源操作审计日志的 `subsystem` 字段必须设置为 `"k8s"`
- **FR-408**：系统必须记录操作失败的审计日志（包含失败原因）

#### FR-5 组：终端访问审计

- **FR-501**：系统必须记录所有节点终端访问（连接成功时）
- **FR-502**：系统必须记录所有容器终端访问（Exec 成功时）
- **FR-503**：终端访问审计日志必须包含：访问类型、目标资源（节点名称或 Pod 名称）、操作者、时间戳、客户端 IP
- **FR-504**：终端访问审计日志必须关联到对应的终端录制记录（recording_id）
- **FR-505**：终端访问审计日志必须使用统一 AuditEvent 系统存储
- **FR-506**：终端访问审计日志的 `action` 字段必须使用标准化名称（`"NodeTerminalAccess"` 或 `"PodTerminalAccess"`）

#### FR-6 组：审计日志查询

- **FR-601**：系统必须提供审计日志查询界面（分页显示，每页 50 条）
- **FR-602**：用户必须能够按操作者筛选审计日志
- **FR-603**：用户必须能够按操作类型（创建、更新、删除、终端访问）筛选审计日志
- **FR-604**：用户必须能够按资源类型（Deployment、Service、Pod 等）筛选审计日志
- **FR-605**：用户必须能够按时间范围筛选审计日志
- **FR-606**：用户必须能够按集群筛选审计日志
- **FR-607**：审计日志查询结果必须按时间倒序排列（最新的在前）
- **FR-608**：系统必须支持审计日志的全文搜索（搜索资源名称、操作者、描述）

#### FR-7 组：只读操作审计

- **FR-701**：系统必须审计所有只读操作（查看 Pod 详情、查看日志、查看 YAML、查看事件等）
- **FR-702**：只读审计日志必须记录操作类型（`"ViewResource"`）、资源类型、资源名称、操作者、时间戳
- **FR-703**：只读审计日志必须与修改操作使用相同的 AuditEvent 模型（通过 `action` 字段区分）
- **FR-704**：系统必须支持审计日志查询时筛选只读操作和修改操作

#### FR-8 组：审计日志保留与清理

- **FR-801**：审计日志必须保留 90 天（与统一终端录制系统和其他审计日志保持���致）
- **FR-802**：系统必须提供定时任务自动清理过期审计日志（每日凌晨 2 点执行）
- **FR-803**：管理员必须能够手动触发审计日志清理
- **FR-804**：清理操作本身必须记录审计日志

### 关键实体 *（涉及数据）*

#### TerminalRecording（复用 009-3）
现有的统一终端录制模型，需要扩展以支持 K8s 终端类型：
- **recording_type**：录制类型，新增值 `"k8s_node"`（节点终端）和 `"k8s_pod"`（容器终端）
- **type_metadata**：类型特定元数据（JSONB），K8s 类型需包含：
  - `cluster_id`（UUID）：集群 ID
  - `node_name`（string）：节点名称（仅节点终端）
  - `namespace`（string）：命名空间（仅容器终端）
  - `pod_name`（string）：Pod 名称（仅容器终端）
  - `container_name`（string）：容器名称（仅容器终端）

#### AuditEvent（统一审计系统）
现有的统一审计事件模型，需要确保支持 K8s 子系统的审计：
- **subsystem**：子系统标识，K8s 审计使用 `"k8s"`
- **action**：操作类型，K8s 审计使用标准化名称：
  - 资源操作：`"CreateResource"`、`"UpdateResource"`、`"DeleteResource"`
  - 只读操作：`"ViewResource"`（查看 Pod 详情、查看日志、查看 YAML、查看事件等）
  - 终端访问：`"NodeTerminalAccess"`、`"PodTerminalAccess"`
- **resource_type**：资源类型（如 `"Deployment"`、`"Service"`、`"Pod"`）
- **resource_id**：资源标识符（如资源名称或 UUID）
- **metadata**：操作详情（JSONB），K8s 审计需包含：
  - `cluster_id`（UUID）：集群 ID
  - `namespace`（string）：命名空间（如有）
  - `resource_name`（string）：资源名称
  - `change_summary`（string）：变更摘要（仅更新操作）
  - `recording_id`（UUID）：关联的录制 ID（仅终端访问）

#### K8sTerminalSession（新增概念，非数据库实体）
表示活动的 K8s 终端会话（WebSocket 连接），用于协调录制：
- 会话 ID（UUID）
- 会话类型（节点终端或容器终端）
- 目标资源（节点名称或 Pod/容器信息）
- 录制状态（录制中/已停止）
- 关联的 TerminalRecording ID

---

## 审查与验收清单
*门禁：在 main() 执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的 [需要澄清] 标记（所有 5 个澄清项已解决）
- [x] 需求可测试且明确
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设（依赖 009-3 统一终端录制系统、统一 AuditEvent 系统）

### 需要澄清��项目
1. ~~**录制格式**：录制格式是否必须是 Asciinema v2 格式？~~ ✅ 已解决：必须使用 Asciinema v2
2. ~~**录制开关**：录制功能是否默认启用？还是需要配置开关？~~ ✅ 已解决：默认启用
3. ~~**只读审计**：是否需要审计只读操作（如查看 Pod 详情、查看日志、查看 YAML）？~~ ✅ 已解决：需要审计只读操作
4. ~~**审计保留**：审计日志保留期限是多久？30 天、90 天、365 天？~~ ✅ 已解决：90 天
5. ~~**录制时长限制**：终端会话是否需要限制最大录制时长？~~ ✅ 已解决：限制为 2 小时

---

## 执行状态
*由 main() 在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记并解决（5 个澄清项全部完成）
- [x] 用户场景已定义（16 个验收场景）
- [x] 需求已生成（44 个功能需求）
- [x] 实体已识别（TerminalRecording、AuditEvent、K8sTerminalSession）
- [x] 审查清单已通过（所有澄清项已解决，规格完整且可进入规划阶段）

---

## 依赖关系

### 上游依赖
- **009-3 统一终端录制系统**：必须已实现 TerminalRecording 模型、StorageService、CleanupService
- **统一 AuditEvent 系统**：必须已实现 AuditEvent 模型和审计日志基础设施

### 下游影响
- K8s 终端功能（节点终端、容器终端）将依赖此功能的录制能力
- K8s 资源操作 API 将依赖此功能的审计能力
- 系统管理的审计日志查询界面将包含 K8s 子系统的审计记录

---

## 假设与约束

### 假设
- 统一终端录制系统（009-3）已完成并可用
- 统一 AuditEvent 系统已完成并可用
- K8s 终端功能（节点终端、容器终端）的基础 WebSocket 连接已实现
- K8s 资源操作 API 已实现且可以插入审计逻辑

### 约束
- 录制文件格式必须与统一终端录制系统兼容
- 审计日志必须使用统一 AuditEvent 模型（不能自定义 K8s 专用审计表）
- 录制和审计功能不能显著影响终端和资源操作的性能（延迟增加 < 100ms）
- 录制文件存储必须考虑磁盘空间限制（需要自动清理机制）

---

## 成功标准

### 可衡量指标
- **录制覆盖率**：100% 的节点终端和容器终端会话被录制
- **审计覆盖率**：100% 的资源操作（创建、更新、删除）和终端访问被审计
- **录制完整性**：录制文件能够完整回放，无丢失或损坏
- **审计完整性**：审计日志包含所有必需字段，无缺失
- **性能影响**：终端连接延迟增加 < 100ms，资源操作延迟增加 < 50ms
- **存储管理**：录制文件和审计日志自动清理，不会无限增长

### 验收标准
- 所有 16 个验收场景通过测试
- 所有边缘情况有明确的处理策略
- 录制文件可以在统一终端录制系统的回放界面中播放
- 审计日志可以在系统管理的审计日志页面中查询和筛选
- 与 009-3 统一终端录制系统集成测试通过
- 与统一 AuditEvent 系统集成测试通过

---

## 下一步

1. ✅ **澄清阶段**（/spec-kit:clarify）：已完成，5 个澄清项全部解决
2. ⏭️ **规划阶段**（/spec-kit:plan）：生成详细的实施计划和任务分解
3. **实施阶段**（/spec-kit:implement）：按任务顺序实施功能
