# 功能规格：MinIO 对象存储管理系统

**功能分支**：`004-minio-minio-bucket`
**创建日期**：2025-10-14
**状态**：已澄清 - 可进入规划阶段
**输入**：用户描述："实现多个minio实例管理，支持minio的bucket管理、用户授权管理、文件浏览、视频图片支持在线浏览、支持分享等"

## 执行流程(main)
```
1. 从输入解析用户描述
   → 已识别:多实例MinIO管理、Bucket管理、用户授权、文件浏览、在线预览、分享
2. 从描述中提取关键概念
   → 参与者:系统管理员、普通用户
   → 操作:实例管理、Bucket操作、用户授权、文件浏览、在线预览、分享链接生成
   → 数据:MinIO实例、Bucket、用户、文件对象、分享链接
   → 约束:安全性、多实例支持、预览支持、分享控制
3. 已标记的8个不清晰方面 → ✅ 已全部澄清
4. 用户场景已填充(见下方)
5. 功能需求已生成(每个需求可测试)
6. 已识别关键实体:MinIO实例、Bucket、MinIO用户、权限策略、文件对象、分享链接、审计日志
7. 审查清单结果:
   → ✅ 无实现细节
   → ✅ 所有歧义已澄清
8. 返回:规格已完成,可进入规划阶段
```

---

## ⚡ 快速指南
- ✅ 专注于管理员和用户需要方便、安全地管理对象存储资源
- ❌ 避免具体实现(不涉及MinIO SDK、S3 API、前端UI框架)
- 👥  为运维人员和普通用户而非开发人员编写

---

## 澄清

### 会话 2025-10-14
- 问：用户权限模型如何设计?谁可以管理实例和创建用户? → 答：只有系统管理员有这些权限,普通用户无权限管理实例和创建用户
- 问：分享链接的访问控制策略? → 答：使用MinIO原生presigned URL功能,无需额外实现
- 问：在线预览支持的文件类型和大小限制? → 答：无大小限制,支持图片、视频、代码文件(语法高亮)、Markdown(渲染)
- 问：文件上传功能的大小限制?是否支持断点续传? → 答：无大小限制,支持多文件上传和断点续传
- 问：审计日志的保留策略? → 答：保留90天,记录管理操作(实例、Bucket、用户、分享),不记录普通文件浏览
- 问：视频播放方式? → 答：使用浏览器原生video标签 + presigned URL,支持HTTP Range请求实现渐进式加载
- 问：文件夹操作支持范围? → 答：支持创建和删除文件夹,不支持重命名(对象存储限制)
- 问：权限控制粒度? → 答：支持Bucket级权限和前缀级权限(目录级),可授权用户访问特定Bucket或Bucket下的特定目录

---

## 用户场景与测试 *（必填）*

### 主要用户故事

**作为系统管理员**,我需要在Dashboard中统一管理多个MinIO实例,以便:
- 快速查看所有MinIO实例的连接状态和基本信息
- 为不同团队创建隔离的Bucket和用户账户
- 授予适当的权限给不同用户访问特定Bucket
- 查看存储使用情况和审计日志
- 管理分享链接和访问控制

**作为普通用户**,我需要浏览和管理我有权限的文件,以便:
- 查看我有权限访问的Bucket和文件列表
- 在浏览器中直接预览图片、视频、代码文件、Markdown而无需下载
- 生成分享链接给其他人访问特定文件
- 上传和下载文件(支持大文件、断点续传)
- 组织文件到文件夹(创建、删除文件夹)

**典型工作流程(管理员)**:
1. 管理员登录Dashboard,进入MinIO管理模块
2. 添加MinIO实例,配置端点、访问密钥
3. 测试连接并查看实例基本信息(版本、存储容量)
4. 选择目标实例,查看所有Bucket列表
5. 创建新Bucket并配置策略(私有/公开读)
6. 创建MinIO用户并设置访问密钥
7. 为用户授予对特定Bucket的读写权限
8. 查看审计日志确认操作已记录

**典型工作流程(普通用户)**:
1. 用户登录Dashboard,进入文件管理模块
2. 选择有权限的Bucket
3. 浏览文件和文件夹,使用搜索功能定位文件
4. 点击图片文件,在弹窗中预览
5. 点击视频文件,在浏览器中播放
6. 选择文件,点击分享,设置过期时间,生成分享链接
7. 复制链接发送给协作者,无需登录即可访问
8. 上传新文件到当前文件夹

### 验收场景

#### MinIO实例管理场景
1. **假定** 未添加任何实例,**当** 管理员添加MinIO实例并提供正确凭据,**那么** 系统显示连接成功并展示实例信息
2. **假定** 已添加实例,**当** 实例离线或凭据错误,**那么** 系统显示错误状态和诊断信息
3. **假定** 管理多个实例,**当** 管理员请求实例列表,**那么** 系统显示所有实例及其连接状态、版本、存储使用情况

#### Bucket管理场景
4. **假定** 已连接MinIO实例,**当** 管理员请求Bucket列表,**那么** 系统显示所有Bucket及其大小、文件数量、创建时间
5. **假定** 在Bucket列表,**当** 创建新Bucket"project-assets"并设置私有策略,**那么** 系统创建Bucket并应用策略
6. **假定** Bucket存在,**当** 删除Bucket,**那么** 系统提示确认(如果Bucket非空则警告)并记录操作到审计日志
7. **假定** Bucket已创建,**当** 修改Bucket策略从私有改为公开读,**那么** 系统更新策略并立即生效

#### 用户与权限管理场景
8. **假定** 在MinIO实例,**当** 创建用户"dev_user"并生成访问密钥,**那么** 系统创建用户并显示密钥(仅显示一次)
9. **假定** 用户已创建,**当** 为用户授予"project-bucket"的读写权限,**那么** 该用户可以上传下载该Bucket的文件
10. **假定** 用户有多个权限,**当** 撤销用户对"old-bucket"的权限,**那么** 该用户无法访问该Bucket但保留其他权限
11. **假定** 用户已授权,**当** 请求用户的权限列表,**那么** 系统显示所有Bucket权限及权限类型(只读/读写)
12. **假定** 管理员配置权限,**当** 授予用户"media-bucket"的"videos/"前缀读权限,**那么** 该用户只能访问该前缀下的文件

#### 文件浏览与预览场景
13. **假定** 用户有Bucket读权限,**当** 浏览Bucket,**那么** 系统显示文件列表(名称、大小、修改时间)和文件夹
14. **假定** 在文件列表,**当** 点击文件夹,**那么** 系统进入该文件夹并显示其内容(支持面包屑导航)
15. **假定** 文件列表中有图片文件,**当** 点击预览,**那么** 系统在弹窗中显示图片(支持缩放、旋转)
16. **假定** 文件列表中有视频文件,**当** 点击播放,**那么** 系统在浏览器中播放视频(支持进度控制、音量调节、HTTP Range渐进式加载)
17. **假定** 文件列表中有代码文件(.py/.go/.js等),**当** 点击预览,**那么** 系统显示语法高亮的代码内容
18. **假定** 文件列表中有Markdown文件,**当** 点击预览,**那么** 系统渲染Markdown并显示格式化内容

#### 文件分享场景
19. **假定** 用户有Bucket读权限,**当** 选择文件并生成分享链接(使用MinIO presigned URL,设置7天过期),**那么** 系统生成唯一URL
20. **假定** 分享链接已生成,**当** 未登录用户访问链接,**那么** 系统允许访问并显示文件(下载或预览)
21. **假定** 分享链接已过期,**当** 访问链接,**那么** 系统显示链接已失效
22. **假定** 管理员查看分享记录,**当** 请求所有分享链接,**那么** 系统显示所有链接及其状态、过期时间

#### 文件上传下载场景
23. **假定** 用户有Bucket写权限,**当** 上传大文件到文件夹,**那么** 系统显示上传进度并支持断点续传
24. **假定** 用户选择多个文件,**当** 批量上传,**那么** 系统并行上传并显示每个文件的进度
25. **假定** 用户选择文件,**当** 点击下载,**那么** 系统开始下载并显示进度

### 边缘情况
- 当MinIO实例连接失败时会发生什么?(显示错误状态、重试机制)
- 系统如何处理Bucket名称冲突?(验证唯一性、错误提示)
- 删除非空Bucket时如何处理?(警告用户、要求确认)
- 文件上传过程中网络中断如何处理?(断点续传、重试机制)
- 预览视频时不支持的编码格式如何处理?(显示不支持提示、提供下载)
- 分享链接被恶意频繁访问如何防护?(访问频率限制、验证码)
- 用户权限被撤销后已生成的分享链接如何处理?(自动失效)
- 如何防止路径遍历攻击?(输入验证、权限检查)
- 多个用户同时修改Bucket策略如何处理?(乐观锁、冲突提示)

## 需求 *（必填）*

### 功能需求

#### MinIO实例管理
- **FR-001**: 系统必须支持添加和管理多个MinIO实例,包括端点URL、访问密钥、密钥密码
- **FR-002**: 系统必须显示每个实例的连接状态(在线/离线/错误)和元信息(版本、存储容量、已用空间)
- **FR-003**: 系统必须支持测试MinIO连接并提供详细的错误诊断信息
- **FR-004**: 系统必须加密存储MinIO实例的访问凭据
- **FR-005**: 系统必须支持编辑实例信息(名称、端点、凭据)
- **FR-006**: 系统必须支持删除实例(删除前检查是否有关联数据)

#### Bucket管理
- **FR-007**: 系统必须列出MinIO实例中的所有Bucket及其大小、对象数量、创建时间
- **FR-008**: 系统必须支持创建新Bucket并验证名称合法性(符合S3命名规范)
- **FR-009**: 系统必须支持删除Bucket(如果Bucket非空则警告并要求确认)
- **FR-010**: 系统必须支持配置Bucket策略(私有/公开读/公开读写)
- **FR-011**: 系统必须显示Bucket的详细信息(策略、版本控制、加密状态)
- **FR-012**: 系统必须支持Bucket搜索和筛选功能

#### 用户与权限管理
- **FR-013**: 系统必须限制只有系统管理员可以管理MinIO实例和创建用户,普通用户无此权限
- **FR-014**: 系统必须列出MinIO实例中的所有用户及其权限摘要
- **FR-015**: 系统必须支持创建MinIO用户并生成访问密钥对(AccessKey/SecretKey)
- **FR-016**: 系统必须在用户创建后仅显示一次SecretKey(安全考虑)
- **FR-017**: 系统必须支持删除用户账户并处理相关权限清理
- **FR-018**: 系统必须支持为用户授予Bucket级别的权限,提供三种权限类型:只读(GET/LIST)、只写(PUT/DELETE)、读写(完全访问)
- **FR-019**: 系统必须支持为用户授予前缀级权限(目录级),允许用户只访问Bucket下特定前缀的对象
- **FR-020**: 系统必须支持撤销用户的Bucket权限或前缀权限
- **FR-021**: 系统必须显示用户的所有当前权限列表(Bucket、前缀、权限类型)

#### 文件浏览
- **FR-022**: 系统必须列出Bucket中的所有对象,包括文件名、大小、最后修改时间、内容类型
- **FR-023**: 系统必须支持文件夹导航(进入子文件夹、返回上级、面包屑导航)
- **FR-024**: 系统必须支持文件和文件夹的搜索功能(按名称、类型筛选)
- **FR-025**: 系统必须支持文件列表排序(按名称、大小、修改时间)
- **FR-026**: 系统必须支持分页加载大量文件(虚拟滚动或懒加载)
- **FR-027**: 系统必须根据用户权限过滤可见的Bucket和文件(包括前缀级权限)
- **FR-028**: 系统必须支持创建和删除文件夹,但不支持重命名(对象存储限制)

#### 在线预览
- **FR-029**: 系统必须支持在线预览图片文件(JPEG、PNG、GIF、WebP、SVG),无大小限制
- **FR-030**: 系统必须支持在线播放视频文件(MP4、WebM、OGG等浏览器原生支持格式),无大小限制
- **FR-031**: 系统必须支持代码文件预览并提供语法高亮(常见编程语言:.py/.go/.js/.java/.c/.cpp等)
- **FR-032**: 系统必须支持Markdown文件预览并渲染为格式化的HTML内容
- **FR-033**: 系统必须在预览界面提供基本控制(图片:缩放、旋转;视频:播放/暂停、进度、音量)
- **FR-034**: 系统必须使用MinIO presigned URL配合HTTP Range请求实现视频渐进式加载(避免全文件下载)
- **FR-035**: 系统必须在文件格式不支持预览时提示用户并提供下载选项

#### 文件分享
- **FR-036**: 系统必须使用MinIO原生presigned URL功能生成临时分享链接
- **FR-037**: 系统必须支持设置分享链接的过期时间(1小时、1天、7天、30天、永久),默认7天
- **FR-038**: 系统必须允许未登录用户通过分享链接访问文件(直接下载或预览)
- **FR-039**: 系统必须在分享链接过期后自动拒绝访问
- **FR-040**: 系统必须记录分享链接的创建信息(创建者、文件、过期时间)到审计日志
- **FR-041**: 系统必须显示用户创建的所有分享链接及其状态(活跃/过期)

#### 文件上传下载
- **FR-042**: 系统必须支持文件上传到Bucket的指定路径(文件夹),无大小限制
- **FR-043**: 系统必须显示上传进度(百分比、速度、预计剩余时间)
- **FR-044**: 系统必须支持多文件批量上传并并行处理
- **FR-045**: 系统必须支持断点续传功能(使用multipart upload)
- **FR-046**: 系统必须支持文件下载并显示下载进度
- **FR-047**: 系统必须支持批量下载(打包为ZIP)
- **FR-048**: 系统必须验证用户权限(只有有写权限的用户可以上传、有读权限的可以下载)

#### 安全与审计
- **FR-049**: 系统必须基于用户角色控制MinIO管理功能的访问权限(只有管理员可管理实例和用户)
- **FR-050**: 系统必须加密存储MinIO实例的访问凭据(AES-256)
- **FR-051**: 系统必须记录所有MinIO管理操作到审计日志(实例管理、Bucket操作、用户授权、分享链接创建)
- **FR-052**: 系统必须记录文件的上传和删除操作(不记录普通浏览和下载以控制日志量)
- **FR-053**: 系统必须保留审计日志90天,超期自动清理
- **FR-054**: 系统必须提供审计日志查询功能,支持按时间、用户、操作类型、资源筛选
- **FR-055**: 系统必须防止路径遍历攻击(验证文件路径、禁止访问上级目录)
- **FR-056**: 系统必须限制分享链接的访问频率(防止滥用)

#### 监控与告警
- **FR-057**: 系统必须监控MinIO实例的连接状态并在连接失败时告警
- **FR-058**: 系统必须显示实例的存储使用情况(已用空间、可用空间、使用率)
- **FR-059**: 系统必须显示Bucket级别的存储使用和对象数量统计

### 关键实体 *（数据相关）*
- **MinIO实例(MinIO Instance)**: 表示一个可管理的MinIO服务器,包含端点URL、访问凭据、连接状态、元信息(版本、存储容量)
- **Bucket**: MinIO中的存储容器,包含名称、大小、对象数量、策略配置(私有/公开)、创建时间
- **MinIO用户(MinIO User)**: MinIO服务中的用户账户,包含用户名、访问密钥对(AccessKey/SecretKey)、关联的权限列表
- **权限策略(Bucket Permission)**: 定义用户对Bucket或前缀的访问权限,包含用户引用、Bucket引用、可选前缀(目录路径)、权限类型(只读/只写/读写)
- **文件对象(File Object)**: MinIO中存储的文件,包含Bucket、路径、名称、大小、内容类型、最后修改时间、ETag
- **分享链接(Share Link)**: 基于MinIO presigned URL的临时访问链接,包含文件对象引用、创建者、创建时间、过期时间
- **审计日志(MinIO Audit Log)**: 记录MinIO管理操作和重要文件操作,包含操作者、时间戳、操作类型(实例管理/Bucket操作/用户授权/文件上传删除/分享)、资源、操作结果、IP地址

---

## 审查与验收清单
*门禁:在main()执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节(语言、框架、API)
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者(运维管理员和普通用户)编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的[需要澄清]标记 - **所有8个澄清点已确认**
- [x] 需求可测试且明确(每个FR都有具体验收标准)
- [x] 成功标准可衡量(通过验收场景验证)
- [x] 范围明确界定(聚焦MinIO对象存储管理)
- [x] 已识别依赖关系和假设(依赖认证系统、审计系统)

---

## 执行状态
*由main()在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取(参与者、操作、数据、约束)
- [x] 歧义已标记并全部澄清(8个澄清点)
- [x] 用户场景已定义(25个验收场景+9个边缘情况)
- [x] 需求已生成(59个功能需求)
- [x] 实体已识别(7个关键实体)
- [x] 关键歧义已澄清(8个问题)
- [x] 审查清单已通过 - **规格已完成,可进入规划阶段**

---

## 下一步行动

**当前状态**: 规格已完成澄清,所有核心决策已确定

**已澄清的关键决策**:
- ✅ 权限模型: 仅管理员可管理实例和创建用户,支持Bucket级和前缀级(目录级)权限授权
- ✅ 分享功能: 使用MinIO原生presigned URL,默认7天过期
- ✅ 预览支持: 无大小限制,支持图片、视频、代码文件(语法高亮)、Markdown(渲染)
- ✅ 上传功能: 无大小限制,支持多文件上传和断点续传
- ✅ 审计策略: 保留90天,记录管理操作和文件上传删除,不记录普通浏览
- ✅ 视频播放: 浏览器原生video标签 + presigned URL + HTTP Range渐进式加载
- ✅ 文件夹操作: 支持创建和删除,不支持重命名
- ✅ 权限粒度: 初始版本即支持前缀级(目录级)细粒度权限

**功能范围总结**:
- 多实例管理、Bucket CRUD、用户管理
- 前缀级细粒度权限控制
- 文件浏览、上传下载(断点续传)、文件夹管理
- 多格式在线预览(图片、视频、代码、Markdown)
- Presigned URL 分享
- 审计日志和监控

**建议流程**:
1. **立即执行**: `/spec-kit:plan` - 基于已澄清需求生成技术设计方案
2. **任务分解**: `/spec-kit:tasks` - 将设计方案分解为可执行任务
3. **开始实施**: `/spec-kit:implement` - 执行开发任务

**参考已有功能**:
- 数据库管理系统(`003-nosql-sql`)的实例管理、用户授权、加密存储、审计日志模式
- 主机管理系统(`002-nezha-webssh`)的WebSocket实时通信模式(可用于上传进度推送)
