# 功能规格：统一终端录制系统

**功能分支**：`009-3`
**创建日期**：2025-10-26
**状态**：草稿
**输入**：用户描述："目前有3个地方涉及到终端录制的，是不是需要统一一下终端录制实现、保存路径及清理策略"

## 执行流程（main）
```
1. 从输入解析用户描述
   → 已识别：统一三个终端录制位置
2. 从描述中提取关键概念
   → 参与者：系统管理员、运维人员、安全审计员
   → 操作：查看录制、管理存储、审计终端访问
   → 数据：终端录制文件、元数据
   → 约束：统一存储路径、一致的清理策略、统一的访问接口
3. 对于每个不清晰的方面：
   → 已通过澄清会话解决（5 个问题）
4. 填充用户场景与测试部分
   → 已完成
5. 生成功能需求
   → 已完成
6. 识别关键实体（如果涉及数据）
   → 已完成
7. 运行审查清单
   → 通过：所有歧义已解决
8. 返回：成功（规格已准备好进行规划）
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现（不涉及技术栈、API、代码结构）
- 👥 为业务利益相关者而非开发人员编写

---

## 澄清

### 会话 2025-10-26
- 问：录制保留期限默认值？ → 答：可配置，默认 90 天
- 问：清理任务执行时间？ → 答：凌晨 4:00
- 问：总存储配额限制？ → 答：暂时不限制
- 问：MinIO 对象存储支持？ → 答：可选功能
- 问：存储切换时的迁移策略？ → 答：保留双存储（新录制用新路径，旧录制仍可访问）

---

## 用户场景与测试 *（必填）*

### 主要用户故事

**作为系统管理员**，我需要所有终端会话（Docker 容器、主机 SSH、K8s 节点）的录制文件都保存在统一位置，这样我可以：
- 在一个地方查看所有终端录制
- 使用统一的策略管理存储空间
- 避免因不同子系统使用不同路径导致的混乱

**作为安全审计员**，我需要所有终端录制自动清理过期文件，这样我可以：
- 确保系统不会因录制文件占满磁盘
- 按照公司合规要求保留指定期限的审计记录
- 减少手动清理旧文件的工作量

**作为运维人员**，我需要统一的录制查看界面，这样我可以：
- 不需要记住不同子系统的录制入口
- 使用统一的搜索和过滤功能查找历史终端会话
- 快速定位问题发生时的终端操作记录

### 验收场景

1. **假定** 系统中存在 Docker 终端、WebSSH 终端、K8s 终端三种录制，**当** 用户访问录制管理页面，**那么** 应显示所有类型的录制，且可按类型过滤

2. **假定** 某个录制文件已保存 90 天（假设保留期为 90 天），**当** 清理任务运行，**那么** 该录制应被自动删除，并释放存储空间

3. **假定** 用户开始一个 Docker 容器终端会话，**当** 会话结束后，**那么** 录制文件应保存在与 WebSSH 和 K8s 终端相同的目录结构中

4. **假定** 系统管理员修改了录制保留期限配置，**当** 下次清理任务运行，**那么** 应使用新的保留期限清理过期录制

5. **假定** 某个终端会话异常中断（如网络断开），**当** 清理任务运行，**那么** 系统应清理未正常完成的无效录制（零文件大小或零时长）

### 边缘情况

- 当清理任务运行时，如果有正在进行的录制会话，系统如何避免删除正在写入的文件？
- 当存储路径配置从本地文件系统改为对象存储（如 MinIO），系统保留双存储：新录制写入新存储位置，旧录制仍从原存储位置访问
- 当录制文件被手动删除但数据库记录仍存在，用户尝试播放时系统如何提示？
- 当多个子系统同时创建录制文件，如何避免文件名冲突？
- 当磁盘空间不足导致录制文件写入失败，系统如何通知用户？

## 需求 *（必填）*

### 功能需求

**存储统一**：
- **FR-001**：系统必须将所有终端类型（Docker、WebSSH、K8s）的录制文件保存到统一的存储路径
- **FR-002**：系统必须支持通过配置文件或环境变量指定录制存储路径
- **FR-003**：系统必须按日期（YYYY-MM-DD）组织录制文件目录，便于管理和归档
- **FR-004**：系统必须确保录制文件命名唯一，避免不同子系统间的文件名冲突

**清理策略**：
- **FR-005**：系统必须提供统一的自动清理机制，清理所有类型的过期录制
- **FR-006**：系统必须支持配置录制保留期限（默认 90 天）
- **FR-007**：系统必须定时执行清理任务（默认每天凌晨 4:00）
- **FR-008**：系统必须清理无效录制（零文件大小、零时长、缺失录制文件）
- **FR-009**：系统当前不设置总存储配额限制，仅通过保留期限控制存储

**录制管理**：
- **FR-011**：用户必须能够在统一界面查看所有类型的终端录制
- **FR-012**：用户必须能够按录制类型（Docker/WebSSH/K8s）过滤录制列表
- **FR-013**：用户必须能够按用户、时间范围、会话 ID 搜索录制
- **FR-014**：用户必须能够播放任意类型的终端录制
- **FR-015**：用户必须能够手动删除不需要的录制

**存储抽象**：
- **FR-016**：系统必须支持本地文件系统存储
- **FR-017**：系统可选支持对象存储（MinIO），作为本地文件系统的替代方案
- **FR-018**：系统必须在录制元数据中记录存储类型和路径
- **FR-019**：当存储配置变更时，系统必须保留双存储访问能力（新录制使用新配置，旧录制从原路径访问）

**审计与监控**：
- **FR-020**：系统必须记录清理任务的执行结果（删除数量、释放空间）
- **FR-021**：系统必须在清理失败时记录错误日志
- **FR-022**：系统必须提供存储使用情况统计（总数量、总大小、按类型分组）

### 关键实体 *（如果功能涉及数据则包含）*

- **TerminalRecording（终端录制）**：统一的录制元数据，包含会话 ID、录制类型（Docker/WebSSH/K8s/Pod）、用户信息、时间信息、存储路径、文件大小、终端配置、客户端信息、类型特定元数据（JSON 字段）

- **RecordingStorageConfig（存储配置）**：录制存储配置，包含存储类型（local/minio）、基础路径、MinIO 配置（endpoint、bucket、凭据）、保留期限、清理时间

- **RecordingStatistics（录制统计）**：录制统计信息，包含按类型分组的数量和大小、总存储占用、最早和最新录制时间

---

## 审查与验收清单

### 内容质量
- [x] 没有实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的 [需要澄清] 标记
- [x] 需求可测试且明确
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设

---

## 执行状态

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记
- [x] 用户场景已定义
- [x] 需求已生成
- [x] 实体已识别
- [x] 审查清单已通过

---

## 附录：现状分析

### 当前三个终端录制位置

1. **Docker 容器终端**：
   - 保存路径：`TERMINAL_RECORDING_DIR` 环境变量或 `./data/terminal-recordings`
   - 清理策略：有专门清理服务，清理零大小/零时长录制
   - 数据模型：`models.TerminalRecording`（仅支持 Docker 字段）

2. **WebSSH 主机终端**：
   - 保存路径：构造函数参数或 `./data/recordings`
   - 清理策略：未发现自动清理机制
   - 数据模型：可能使用 `models.WebSSHSession`

3. **K8s 节点/Pod 终端**：
   - 保存路径：未确定
   - 清理策略：未确定
   - 数据模型：未确定

### 需要统一的方面

- **保存路径**：从 3 个不同位置统一到 1 个可配置路径
- **清理策略**：从部分清理扩展到全部子系统
- **数据模型**：从 Docker 专用扩展到支持所有终端类型
- **查询接口**：从分散的 API 统一到单一管理入口