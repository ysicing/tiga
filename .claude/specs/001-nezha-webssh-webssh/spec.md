# 功能规格:主机管理监控与WebSSH

**功能分支**:`001-nezha-webssh-webssh`
**创建日期**:2025-10-07
**状态**:草稿
**输入**:用户描述:"主机管理子系统希望实现nezha相关功能,添加节点后能监控节点状态、服务状态探测功能,webssh登录节点如果开启了webssh功能"

## 执行流程(main)
```
1. 从输入解析用户描述
   → 已识别:主机监控、服务探测、WebSSH
2. 从描述中提取关键概念
   → 参与者:管理员、运维人员
   → 操作:添加主机节点、监控状态、探测服务、SSH登录
   → 数据:主机信息、监控指标、服务状态
   → 约束:WebSSH需要显式开启
3. 标记不清晰的方面
   → [需要澄清:监控指标的具体类型和采集频率]
   → [需要澄清:服务探测支持哪些协议(HTTP/TCP/ICMP)]
   → [需要澄清:WebSSH的认证方式(密码/密钥)]
4. 用户场景已定义
5. 功能需求已生成
6. 关键实体已识别
7. 审查清单待完成
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现(不涉及技术栈、API、代码结构)
- 👥 为业务利益相关者而非开发人员编写

### 章节要求
- **必填章节**:每个功能都必须完成
- **可选章节**:仅在与功能相关时包含
- 当某个章节不适用时,完全移除(不要保留为"不适用")

---

## 用户场景与测试 *(必填)*

### 主要用户故事
作为运维管理员,我需要将服务器主机添加到系统中进行统一管理,以便实时了解所有主机的运行状态和健康情况。

作为运维人员,我需要监控主机上运行的关键服务是否正常,当服务异常时能够及时发现并处理。

作为系统管理员,我需要通过Web界面直接登录到主机进行运维操作,而无需额外的SSH客户端工具。

### 验收场景
1. **假定** 用户拥有管理员权限,**当** 添加新的主机节点并填写主机信息,**那么** 系统应保存主机信息并开始监控该主机状态

2. **假定** 主机已成功添加到系统,**当** 主机代理正常运行,**那么** 系统应显示主机的实时监控数据包括CPU、内存、磁盘、网络等指标

3. **假定** 已配置服务探测规则,**当** 定期执行服务健康检查,**那么** 系统应记录服务状态并在服务异常时触发告警

4. **假定** 主机已开启WebSSH功能且用户有访问权限,**当** 用户点击WebSSH登录按钮,**那么** 系统应在浏览器中打开交互式终端会话

5. **假定** 主机未开启WebSSH功能,**当** 用户尝试WebSSH登录,**那么** 系统应提示该主机不支持WebSSH功能

### 边缘情况
- 当主机网络不可达或代理离线时会发生什么?系统应标记主机为离线状态并停止数据采集
- 当服务探测超时或失败时如何处理?系统应记录失败次数并根据规则判断是否触发告警
- 当WebSSH会话长时间无操作时如何处理?[需要澄清:会话超时策略]
- 当多个用户同时连接到同一主机的WebSSH时如何管理?系统应支持多会话并发
- 当主机监控数据量过大时如何存储?[需要澄清:历史数据保留策略]

## 需求 *(必填)*

### 功能需求

#### 主机节点管理
- **FR-001**:系统必须允许管理员添加新的主机节点,包括主机名、IP地址、操作系统类型等基本信息
- **FR-002**:系统必须支持编辑已添加的主机节点信息
- **FR-003**:系统必须支持删除主机节点,并清理相关的监控数据
- **FR-004**:系统必须显示所有已添加主机的列表视图,包括在线/离线状态

#### 主机状态监控
- **FR-005**:系统必须实时监控主机的CPU使用率、内存使用率、磁盘使用率和网络流量
- **FR-006**:系统必须显示主机的实时监控图表和历史趋势
- **FR-007**:系统必须记录主机的上线/下线时间和事件
- **FR-008**:系统必须在主机状态异常时(如CPU>90%、磁盘>95%)触发告警
- **FR-009**:系统必须支持 [需要澄清:监控数据采集频率 - 实时/10秒/30秒/分钟?]

#### 服务状态探测
- **FR-010**:系统必须支持添加服务探测规则,包括服务名称、探测类型、目标地址
- **FR-011**:系统必须支持 [需要澄清:探测协议类型 - HTTP/HTTPS/TCP/ICMP/自定义?]
- **FR-012**:系统必须定期执行服务健康检查并记录结果
- **FR-013**:系统必须在服务探测失败时记录失败详情(响应码、超时等)
- **FR-014**:系统必须在服务连续失败 [需要澄清:失败次数阈值] 次后触发告警
- **FR-015**:系统必须显示服务的可用性统计(如99.9%在线率)

#### WebSSH功能
- **FR-016**:系统必须支持为主机节点配置是否启用WebSSH功能
- **FR-017**:系统必须在用户有权限且主机已启用WebSSH时,提供浏览器内SSH终端
- **FR-018**:系统必须支持 [需要澄清:WebSSH认证方式 - 密码/SSH密钥/双因素?]
- **FR-019**:系统必须记录所有WebSSH会话的操作日志用于审计
- **FR-020**:系统必须支持WebSSH终端的基本操作(命令执行、文件传输、窗口调整)
- **FR-021**:系统必须在WebSSH会话 [需要澄清:超时时长] 无操作后自动断开连接

#### 告警与通知
- **FR-022**:系统必须支持配置告警规则,包括触发条件和通知方式
- **FR-023**:系统必须通过 [需要澄清:通知渠道 - 邮件/短信/Webhook/钉钉/企业微信?] 发送告警通知
- **FR-024**:系统必须记录所有告警历史并支持查询

#### 权限控制
- **FR-025**:系统必须基于用户角色控制主机管理功能的访问权限
- **FR-026**:系统必须支持为不同用户分配不同主机的访问权限
- **FR-027**:系统必须限制WebSSH功能仅对授权用户开放

### 关键实体 *(如果功能涉及数据则包含)*

- **主机节点(Host)**:表示被监控的服务器,包含主机名、IP地址、操作系统类型、WebSSH启用状态、在线状态、标签等属性

- **监控指标(HostMetric)**:表示主机的监控数据快照,包含CPU、内存、磁盘、网络等指标数值和采集时间戳

- **服务探测规则(ServiceProbe)**:表示需要监控的服务检查配置,包含服务名称、探测类型、目标地址、检查频率、超时设置等

- **服务探测结果(ProbeResult)**:记录每次服务探测的执行结果,包含成功/失败状态、响应时间、错误信息等

- **WebSSH会话(SSHSession)**:表示一个Web终端会话,包含用户信息、主机信息、建立时间、会话ID等

- **告警规则(AlertRule)**:定义监控告警的触发条件和通知配置,与主机或服务关联

- **告警事件(AlertEvent)**:记录触发的告警实例,包含触发时间、告警内容、处理状态等

---

## 审查与验收清单
*门禁:在main()执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节(语言、框架、API)
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [ ] 没有剩余的[需要澄清]标记 - **存在7个需要澄清的问题**
- [x] 需求可测试且明确
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设

---

## 执行状态
*由main()在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记
- [x] 用户场景已定义
- [x] 需求已生成
- [x] 实体已识别
- [ ] 审查清单已通过 - **警告:规格存在7个不确定性需要澄清**

---

## 需要澄清的问题汇总

1. **监控数据采集频率**:监控指标应该多久采集一次?(实时/10秒/30秒/分钟级别)
2. **服务探测协议**:服务探测支持哪些协议类型?(HTTP/HTTPS/TCP/ICMP/自定义协议)
3. **探测失败阈值**:服务连续失败多少次后触发告警?
4. **WebSSH认证方式**:WebSSH支持哪些认证方式?(密码/SSH密钥/双因素认证)
5. **WebSSH会话超时**:WebSSH会话多久无操作后自动断开?
6. **通知渠道**:告警通知支持哪些渠道?(邮件/短信/Webhook/钉钉/企业微信/飞书)
7. **历史数据保留**:监控历史数据保留多长时间?(7天/30天/90天/永久)
