# 功能规格:主机管理子系统-Nezha监控与WebSSH集成

**功能分支**:`002-nezha-webssh`
**创建日期**:2025-10-07
**状态**:草稿
**输入**:用户描述:"主机管理子系统希望实现nezha相关功能,添加节点后能监控节点状态、服务状态探测功能,webssh登录节点如果开启了webssh功能,可以参考 /Users/ysicing/go/src/github.com/nezhahq/nezha 和 /Users/ysicing/go/src/github.com/nezhahq/agent"

## 执行流程(main)
```
1. 从输入解析用户描述
   → 已识别:主机Agent架构、实时监控、服务探测、WebSSH终端
2. 从描述中提取关键概念
   → 参与者:运维管理员、系统管理员、Agent程序
   → 操作:添加主机、Agent连接、数据采集、服务探测、SSH终端
   → 数据:主机信息、监控指标、服务状态、终端会话
   → 约束:Agent-Server架构、gRPC通信、WebSocket终端
3. 参考Nezha项目架构
   → Server-Agent双向通信模式(gRPC)
   → 实时数据流传输
   → WebSocket终端代理
   → 服务监控Cron调度
4. 用户场景已定义
5. 功能需求已生成
6. 关键实体已识别
7. 审查清单待完成
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现(不涉及技术栈、API、代码结构)
- 👥 为业务利益相关者而非开发人员编写

### Nezha架构参考要点
从Nezha项目中学到的核心概念(仅作为功能理解,非实现细节):
- **Agent-Server模式**:轻量级Agent部署在被监控主机上,主动连接到Dashboard
- **实时双向通信**:Agent持续上报数据,Server可下发任务
- **服务探测调度**:定时任务自动执行健康检查
- **WebSSH代理**:通过Agent在主机上执行SSH,终端数据流式传输到浏览器
- **监控指标**:CPU、内存、磁盘、网络、负载、连接数、温度、GPU等

---

## 用户场景与测试 *(必填)*

### 主要用户故事

**US-001:主机节点注册与Agent连接**
作为运维管理员,我需要在Tiga系统中注册新的主机节点并获取Agent安装命令,以便在目标主机上部署Agent并建立监控连接。

**US-002:实时主机状态监控**
作为运维管理员,我需要在Dashboard上实时查看所有主机的运行状态(CPU、内存、磁盘、网络等),以便及时了解基础设施健康状况。

**US-003:服务可用性监控**
作为运维人员,我需要配置服务探测规则(HTTP、TCP、Ping等),系统自动定期检查服务可用性,并在服务异常时触发告警。

**US-004:WebSSH远程登录**
作为系统管理员,我需要通过浏览器直接SSH登录到已启用WebSSH的主机,进行运维操作而无需额外的SSH客户端工具。

**US-005:主机分组管理**
作为运维管理员,我需要将主机按照用途(生产环境、测试环境)或区域进行分组,以便批量管理和设置不同的监控策略。

### 验收场景

**AC-001:主机注册与Agent连接**
1. **假定** 用户拥有管理员权限,**当** 在系统中添加新主机并生成Agent安装命令,**那么** 系统应显示包含唯一密钥的安装脚本
2. **假定** Agent安装脚本在目标主机上执行,**当** Agent启动并连接到Server,**那么** Dashboard应显示主机在线状态并开始接收监控数据
3. **假定** Agent与Server网络连接中断,**当** 超过心跳超时时间,**那么** 系统应标记主机为离线状态

**AC-002:主机状态监控**
1. **假定** Agent已成功连接,**当** Agent定期上报监控数据,**那么** Dashboard应实时更新CPU、内存、磁盘、网络等指标
2. **假定** 用户查看主机详情页,**当** 选择查看历史监控数据,**那么** 系统应展示可配置时间范围内的监控趋势图表
3. **假定** 主机CPU使用率超过设定阈值,**当** 满足告警条件,**那么** 系统应触发告警并发送通知

**AC-003:服务探测**
1. **假定** 用户创建HTTP服务探测规则,**当** 配置目标URL、检查频率和超时时间,**那么** 系统应开始定期执行健康检查
2. **假定** 服务探测执行,**当** 目标服务响应正常,**那么** 系统应记录成功状态和响应时间
3. **假定** 服务探测连续失败达到阈值,**当** 触发告警条件,**那么** 系统应发送告警通知并记录故障事件
4. **假定** 服务从故障恢复,**当** 探测成功,**那么** 系统应发送恢复通知并更新服务状态

**AC-004:WebSSH终端**
1. **假定** 主机已启用WebSSH功能且用户有权限,**当** 用户点击WebSSH登录,**那么** 系统应在浏览器中打开交互式终端
2. **假定** WebSSH会话已建立,**当** 用户输入命令,**那么** 命令应通过Agent在主机上执行并实时回显输出
3. **假定** WebSSH会话空闲超过配置时长,**当** 达到超时,**那么** 系统应自动关闭会话并清理资源
4. **假定** 主机未启用WebSSH或用户无权限,**当** 尝试连接,**那么** 系统应拒绝请求并提示相应信息

**AC-005:主机分组**
1. **假定** 用户创建主机分组,**当** 将多个主机加入同一分组,**那么** 系统应支持按分组筛选和批量操作
2. **假定** 已设置分组级别的告警规则,**当** 分组内任意主机触发条件,**那么** 系统应按分组规则发送告警

### 边缘情况

- **网络波动**:当Agent与Server之间网络不稳定导致短暂断连时,系统应支持自动重连并恢复数据传输,避免频繁的离线/在线状态切换
- **Agent版本不兼容**:当Agent版本与Server不匹配时,系统应检测版本兼容性并提示升级,同时记录警告信息
- **并发WebSSH会话**:当同一主机有多个用户同时建立WebSSH会话时,系统应隔离各会话的IO流,避免数据混乱
- **大规模主机监控**:当监控主机数量达到数百或数千台时,系统应保持响应性能,合理聚合数据展示,避免前端卡顿
- **服务探测超时**:当网络延迟导致服务探测超时但实际服务正常时,系统应区分网络问题和服务问题,提供详细的诊断信息
- **历史数据清理**:当监控历史数据累积过多时,系统应按配置的保留策略自动清理过期数据,防止数据库膨胀
- **告警风暴**:当大量主机或服务同时触发告警时,系统应支持告警聚合和抑制策略,避免通知轰炸

## 需求 *(必填)*

### 功能需求

#### 主机节点管理
- **FR-001**:系统必须支持添加主机节点,为每个主机生成唯一的标识(UUID)和连接密钥
- **FR-002**:系统必须提供Agent安装脚本,包含Server地址、主机密钥等配置信息
- **FR-003**:系统必须支持编辑主机基本信息,如主机名、备注、公开备注、显示顺序
- **FR-004**:系统必须支持删除主机节点,并清理关联的监控数据、会话记录等
- **FR-005**:系统必须支持主机分组功能,允许将主机加入一个或多个分组
- **FR-006**:系统必须显示主机列表,包含在线/离线状态、最后活跃时间、基本资源使用情况
- **FR-007**:系统必须支持对游客隐藏特定主机的选项

#### Agent连接与通信
- **FR-008**:系统必须接受Agent的连接请求,验证主机密钥的有效性
- **FR-009**:系统必须维护Agent的心跳机制,定期检测Agent在线状态
- **FR-010**:系统必须在Agent离线超过阈值时标记主机为离线状态
- **FR-011**:系统必须支持Agent自动重连,在网络恢复后快速建立连接
- **FR-012**:系统必须检测Agent版本,在版本不兼容时发出警告

#### 主机监控数据采集
- **FR-013**:系统必须接收Agent上报的主机基本信息,包括操作系统、CPU型号、内存总量、磁盘总量等
- **FR-014**:系统必须接收Agent上报的实时监控指标,包括:
  - CPU使用率
  - 内存使用量和使用率
  - 交换分区使用量
  - 磁盘使用量和使用率
  - 网络入站/出站流量和速率
  - 系统负载(Load1、Load5、Load15)
  - TCP/UDP连接数
  - 进程数
  - 系统温度传感器数据(如有)
  - GPU使用率(如有)
- **FR-015**:系统必须记录主机的上线/下线事件和时间
- **FR-016**:系统必须存储监控历史数据,支持配置数据保留周期
- **FR-017**:系统必须在主机详情页展示实时监控数据和历史趋势图表
- **FR-018**:系统必须支持按时间范围查询历史监控数据

#### 服务探测
- **FR-019**:系统必须支持创建服务探测规则,包括服务名称、探测类型、目标地址、检查频率
- **FR-020**:系统必须支持多种探测类型:HTTP GET、ICMP Ping、TCP连接
- **FR-021**:系统必须为每个探测规则配置超时时间和重试次数
- **FR-022**:系统必须按配置的频率定期执行服务探测任务
- **FR-023**:系统必须记录每次探测的结果,包括成功/失败状态、响应时间、错误信息
- **FR-024**:系统必须支持探测任务与主机或主机分组关联,控制在哪些主机上执行探测
- **FR-025**:系统必须计算服务的可用性统计,如可用率、平均响应时间
- **FR-026**:系统必须在服务探测失败时触发告警,支持配置失败次数阈值
- **FR-027**:系统必须在服务恢复时发送恢复通知

#### WebSSH终端
- **FR-028**:系统必须支持为主机配置是否启用WebSSH功能
- **FR-029**:系统必须在用户请求WebSSH时,向Agent下发终端任务并生成会话ID
- **FR-030**:系统必须通过WebSocket建立用户浏览器与Agent之间的数据通道
- **FR-031**:系统必须实时传输用户输入和命令输出,保持终端交互体验
- **FR-032**:系统必须支持WebSSH会话的窗口大小调整
- **FR-033**:系统必须在WebSSH会话空闲超时后自动关闭并清理资源
- **FR-034**:系统必须记录WebSSH会话的操作日志,用于审计
- **FR-035**:系统必须支持多用户同时连接到不同主机的WebSSH,隔离各会话
- **FR-036**:系统必须在主机离线或Agent不支持WebSSH时,拒绝WebSSH请求并提示用户

#### 告警与通知
- **FR-037**:系统必须支持配置主机监控告警规则,设置触发条件(如CPU>90%)
- **FR-038**:系统必须支持配置服务探测告警规则,设置失败次数阈值
- **FR-039**:系统必须在告警触发时记录告警事件,包含触发时间、告警内容、主机信息
- **FR-040**:系统必须通过配置的通知渠道发送告警,如邮件、Webhook
- **FR-041**:系统必须支持告警分组,避免重复告警
- **FR-042**:系统必须支持告警恢复通知
- **FR-043**:系统必须提供告警历史查询功能

#### 权限与安全
- **FR-044**:系统必须基于用户角色控制主机管理功能的访问权限
- **FR-045**:系统必须支持为不同用户分配不同主机的查看和操作权限
- **FR-046**:系统必须限制WebSSH功能仅对授权用户开放
- **FR-047**:系统必须验证Agent连接的密钥有效性,拒绝未授权的连接
- **FR-048**:系统必须记录所有敏感操作的审计日志

### 关键实体 *(功能涉及数据)*

- **主机节点(HostNode)**:表示被监控的服务器,包含主机名、UUID、连接密钥、备注、公开备注、分组信息、是否启用WebSSH、显示顺序、对游客隐藏标志等属性

- **主机信息(HostInfo)**:表示主机的静态硬件和系统信息,包含操作系统类型、版本、CPU型号、CPU核心数、内存总量、磁盘总量、交换分区大小、架构(amd64/arm64)、虚拟化类型、Agent版本等

- **主机状态(HostState)**:表示主机的实时监控指标快照,包含CPU使用率、内存使用量、交换分区使用量、磁盘使用量、网络入站/出站流量、网络入站/出站速率、系统运行时间、负载(Load1/5/15)、TCP连接数、UDP连接数、进程数、温度传感器数据、GPU使用率等,及数据采集时间戳

- **主机分组(HostGroup)**:表示主机的分类组织,包含分组名称、描述,主机可属于多个分组

- **服务探测规则(ServiceMonitor)**:表示服务监控配置,包含服务名称、探测类型(HTTP/TCP/ICMP)、目标地址、检查频率(秒)、超时时间、重试次数、关联的主机或主机分组、是否启用告警、告警通知组ID、失败阈值、延迟告警阈值等

- **服务探测结果(ServiceProbeResult)**:记录每次服务探测的执行结果,包含探测规则ID、执行时间、成功/失败状态、响应时间、HTTP状态码(如适用)、错误信息、执行探测的主机ID

- **服务可用性统计(ServiceAvailability)**:聚合服务的可用性数据,包含服务ID、统计周期(小时/天/周/月)、总探测次数、成功次数、失败次数、可用率、平均响应时间、最小响应时间、最大响应时间

- **WebSSH会话(WebSSHSession)**:表示一个Web终端会话,包含会话ID(UUID)、用户ID、主机ID、建立时间、最后活跃时间、会话状态(连接中/已关闭)

- **告警规则(MonitorAlertRule)**:定义监控告警的触发条件,包含规则名称、规则类型(主机监控/服务探测)、关联的主机或服务、触发条件表达式(如CPU>90%)、持续时长、通知组ID、是否启用

- **告警事件(AlertEvent)**:记录触发的告警实例,包含告警规则ID、触发时间、恢复时间、告警级别、告警内容、关联的主机或服务ID、处理状态(待处理/已处理/已忽略)

- **Agent连接状态(AgentConnection)**:表示Agent的连接信息,包含主机ID、连接建立时间、最后心跳时间、Agent版本、连接状态(在线/离线)、地理位置IP信息

---

## 审查与验收清单
*门禁:在main()执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节(语言、框架、API)
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的[需要澄清]标记
- [x] 需求可测试且明确
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设

---

## 执行状态
*由main()在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记(无歧义,参考Nezha架构明确了需求)
- [x] 用户场景已定义
- [x] 需求已生成
- [x] 实体已识别
- [x] 审查清单已通过

---

## 架构参考总结(非实现细节)

从Nezha项目学习到的设计理念:

1. **Agent-Server分离架构**:Agent作为独立程序部署在被监控主机,保持轻量级和低资源占用,通过持久连接主动向Server上报数据

2. **双向任务流**:Server不仅被动接收Agent上报的监控数据,还能主动向Agent下发任务(如服务探测、WebSSH、命令执行等)

3. **实时数据流传输**:监控数据通过流式传输实时更新,而非定期轮询,降低延迟提高实时性

4. **灵活的服务探测**:探测任务可在Agent端执行,支持从不同网络位置验证服务可用性,比单点探测更准确

5. **WebSSH代理模式**:Agent在主机本地执行SSH连接,Server作为WebSocket代理,实现浏览器到远程主机的安全终端访问

6. **分组与批量管理**:通过主机分组实现批量配置、监控和告警策略,适应大规模运维场景

7. **版本兼容性检测**:Agent与Server版本管理,确保通信协议兼容性
