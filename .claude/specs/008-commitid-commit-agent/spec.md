# 功能规格：构建版本信息注入与 Agent Docker 上报控制

**功能分支**：`008-commitid-commit-agent`
**创建日期**：2025-10-26
**状态**：草稿
**输入**：用户描述："我想构建时将构建版本时间commitid打到二进制里，启动时能够显示当前二进制commit和构建时间，这个版本信息方便后续支持agent自动升级判断；agent支持禁用上报docker实例，默认不禁用。"

## 执行流程（main）
```
1. 从输入解析用户描述
   → 提取关键需求：版本信息注入、启动显示、agent docker 上报控制
2. 从描述中提取关键概念
   → 参与者：开发者（构建）、运维人员（查看版本）、系统管理员（配置 agent）
   → 操作：构建时注入信息、启动时显示、禁用 docker 上报
   → 数据：版本号、构建时间、commit ID、docker 上报开关
   → 约束：默认启用 docker 上报
3. 对于每个不清晰的方面：
   → [需要澄清：版本号格式规范（如 v1.0.0、semver？）]
   → [需要澄清：版本信息是否需要通过 API 接口暴露？]
   → [需要澄清：agent 自动升级功能是否本次实现？]
4. 填充用户场景与测试部分
   → 定义构建、启动、配置三个主要场景
5. 生成功能需求
   → 7 个功能需求，覆盖版本信息和 docker 上报控制
6. 识别关键实体
   → VersionInfo、AgentConfig
7. 运行审查清单
   → 警告：规格存在不确定性（版本号格式、API 接口需求）
8. 返回：成功（规格已准备好进行规划）
```

---

## ⚡ 快速指南
- ✅ 专注于用户需要什么和为什么
- ❌ 避免如何实现（不涉及技术栈、API、代码结构）
- 👥 为业务利益相关者而非开发人员编写

### 章节要求
- **必填章节**：每个功能都必须完成
- **可选章节**：仅在与功能相关时包含
- 当某个章节不适用时，完全移除（不要保留为"不适用"）

---

## 澄清

### 会话 2025-10-26

- 问：版本号格式规范：版本号应该从哪里获取？ → 答：最近 git tag + commit 短 hash，如果没有 tag 则使用日期 + commit 短 hash
- 问：版本信息 API 接口：是否需要通过 HTTP API 接口暴露版本信息？ → 答：服务端需要暴露版本 API 供页面显示；agent 需要上报客户端版本到服务端
- 问：自动升级功能范围：agent 自动升级功能是否在本次需求范围内？ → 答：否，本次仅为后续升级功能准备版本信息
- 问：构建环境异常处理：当无法获取 git commit ID 时的处理策略？ → 答：使用固定值 "dev" 或 "snapshot"

---

## 用户场景与测试 *（必填）*

### 主要用户故事

**故事 1：运维人员验证部署版本**
作为运维人员，当我部署新版本的应用或 agent 时，我需要快速确认二进制文件的版本号、构建时间和源代码 commit ID，以确保部署了正确的版本并便于问题追溯。

**故事 2：系统管理员控制 agent 数据上报**
作为系统管理员，我需要能够选择性地禁用某些 agent 的 docker 实例上报功能，以减少不必要的网络流量或满足特定环境的安全要求，同时大多数 agent 默认保持上报状态。

**故事 3：运维人员监控 agent 版本**
作为运维人员，我需要在管理界面查看所有 agent 的版本信息，以便了解各 agent 的部署状态，为未来的升级计划提供依据。

### 验收场景

**场景 1：构建版本信息注入**
1. **假定** 开发者在 git 仓库中执行构建命令，**当** 构建过程完成，**那么** 生成的二进制文件内部包含当前的版本号、构建时间戳和 git commit ID

**场景 2：启动时显示版本信息**
2. **假定** 二进制文件已成功构建，**当** 使用普通命令启动应用，**那么** 应用在启动日志的开头部分显示版本号、构建时间和 commit ID

**场景 3：版本查询命令**
3. **假定** 二进制文件已安装，**当** 用户执行版本查询命令（如 --version 或 version 子命令），**那么** 输出版本信息并立即退出，不启动完整应用

**场景 4：禁用 docker 实例上报**
4. **假定** agent 配置中明确禁用 docker 实例上报，**当** agent 启动并运行，**那么** agent 不会向 server 上报任何 docker 实例信息

**场景 5：默认启用 docker 实例上报**
5. **假定** agent 配置中未设置 docker 实例上报选项，**当** agent 启动并运行，**那么** agent 默认上报 docker 实例信息到 server

**场景 6：服务端 API 查询版本信息**
6. **假定** 服务端正在运行，**当** 前端页面通过 API 接口查询版本信息，**那么** 返回服务端的版本号、构建时间和 commit ID

**场景 7：agent 上报版本信息**
7. **假定** agent 正在运行并连接到服务端，**当** agent 启动或定期上报状态，**那么** agent 将自身的版本号、构建时间和 commit ID 上报到服务端

### 边缘情况

- 当构建时无法获取 git commit ID（如构建环境不是 git 仓库、git 未安装、detached HEAD 状态）时，版本号使用固定值 "dev" 或 "snapshot"，commit ID 字段使用 "0000000"
- 当构建时系统时间不准确时，构建时间戳的可靠性如何保证？
- 当 agent 配置文件损坏或配置项格式错误时，docker 实例上报的默认行为是什么？
- 当 agent 配置在运行时被修改（热更新）时，docker 上报行为是否立即生效还是需要重启？

## 需求 *（必填）*

### 功能需求

- **FR-001**：构建系统必须在编译时将版本号注入到二进制文件中，格式为：优先使用"最近 git tag + commit 短 hash"（如 v1.2.3-a1b2c3d），如果没有 tag 则使用"日期 + commit 短 hash"（如 20251026-a1b2c3d），如果无法获取 git 信息则使用固定值 "dev" 或 "snapshot"
- **FR-002**：构建系统必须在编译时将构建时间戳注入到二进制文件中
- **FR-003**：构建系统必须在编译时将 git commit ID（短格式，7位）注入到二进制文件中，如果无法获取则使用 "0000000"
- **FR-004**：应用（包括 server 和 agent）启动时必须在日志中输出版本号、构建时间和 commit ID
- **FR-005**：应用（包括 server 和 agent）必须提供命令行选项显示版本信息并退出（不启动完整应用）
- **FR-006**：agent 必须支持配置选项控制是否上报 docker 实例信息
- **FR-007**：agent 的 docker 实例上报功能默认状态必须为启用（当配置项未设置或缺失时）
- **FR-008**：服务端必须提供 HTTP API 接口暴露自身的版本信息（版本号、构建时间、commit ID），供前端页面显示
- **FR-009**：agent 启动或定期上报状态时必须将自身的版本信息（版本号、构建时间、commit ID）上报到服务端

### 明确的范围外

以下功能**不在**本次需求范围内，为未来功能保留：
- agent 自动升级功能（版本对比、升级包下载、自动安装）
- 升级通知和提醒机制
- 版本兼容性检查和管理

### 关键实体 *（如果功能涉及数据则包含）*

- **VersionInfo**：表示应用的版本信息，包含版本号（字符串，格式：tag+commit短hash 或 日期+commit短hash）、构建时间（时间戳）、commit ID（字符串，7位短格式）。这些信息在构建时确定，运行时不可变。
- **AgentConfig**：表示 agent 的配置信息，包含 docker 实例上报开关（布尔值）。默认值为 true（启用上报）。

---

## 审查与验收清单
*门禁：在 main() 执行期间运行的自动检查*

### 内容质量
- [x] 没有实现细节（语言、框架、API）
- [x] 专注于用户价值和业务需求
- [x] 为非技术利益相关者编写
- [x] 所有必填章节已完成

### 需求完整性
- [x] 没有剩余的 [需要澄清] 标记
- [x] 需求可测试且明确（FR-001 到 FR-009 可测试）
- [x] 成功标准可衡量
- [x] 范围明确界定
- [x] 已识别依赖关系和假设（构建环境依赖已明确，异常处理策略已定义）

---

## 执行状态
*由 main() 在处理过程中更新*

- [x] 用户描述已解析
- [x] 关键概念已提取
- [x] 歧义已标记并解决（4 个澄清点已全部澄清）
- [x] 用户场景已定义（7 个场景）
- [x] 需求已生成（9 个明确需求）
- [x] 实体已识别（VersionInfo、AgentConfig）
- [x] 审查清单已通过

---

